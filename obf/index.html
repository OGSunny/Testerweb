<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Lua Deobfuscator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #00d4ff, #0080ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: #888;
            font-size: 1.1em;
        }

        .settings-panel {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .methods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .method-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(50, 50, 70, 0.5);
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .method-item:hover {
            background: rgba(60, 60, 80, 0.7);
        }

        .method-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        button, .file-upload-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-upload {
            background: #0080ff;
            color: white;
        }

        .btn-upload:hover {
            background: #0066cc;
        }

        .btn-process {
            background: #00cc66;
            color: white;
        }

        .btn-process:hover {
            background: #00aa55;
        }

        .btn-process:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn-download {
            background: #9933ff;
            color: white;
        }

        .btn-download:hover {
            background: #7722cc;
        }

        .btn-download:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn-clear {
            background: #ff3366;
            color: white;
        }

        .btn-clear:hover {
            background: #cc2244;
        }

        .file-upload-btn {
            background: #0080ff;
            color: white;
            position: relative;
        }

        .file-upload-btn input[type="file"] {
            display: none;
        }

        .code-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .code-area {
                grid-template-columns: 1fr;
            }
        }

        .code-section {
            display: flex;
            flex-direction: column;
        }

        .code-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }

        textarea {
            width: 100%;
            height: 400px;
            background: rgba(20, 20, 30, 0.9);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 15px;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .output-area {
            color: #00d4ff !important;
        }

        .logs-panel {
            background: rgba(30, 30, 50, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
        }

        .logs-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .logs-content {
            background: #000;
            border-radius: 5px;
            padding: 15px;
            height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            color: #aaa;
            margin-bottom: 5px;
        }

        .log-entry.success {
            color: #0f0;
        }

        .log-entry.error {
            color: #f33;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 0.9em;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚ö° Advanced Lua Deobfuscator</h1>
            <p>Multi-strategy deobfuscation engine with 8 powerful methods</p>
        </div>

        <!-- Settings Panel -->
        <div class="settings-panel">
            <div class="settings-header">
                <span>‚öôÔ∏è</span>
                <span>Deobfuscation Methods</span>
            </div>
            <div class="methods-grid" id="methodsGrid">
                <!-- Methods will be populated by JavaScript -->
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <label class="file-upload-btn">
                üì§ Upload File
                <input type="file" id="fileInput" accept=".lua,.txt">
            </label>
            <button class="btn-process" id="processBtn">
                <span>‚ö°</span>
                <span id="processBtnText">Deobfuscate</span>
            </button>
            <button class="btn-download" id="downloadBtn" disabled>
                <span>üíæ</span>
                <span>Download</span>
            </button>
            <button class="btn-clear" id="clearBtn">
                <span>üóëÔ∏è</span>
                <span>Clear</span>
            </button>
        </div>

        <!-- Code Areas -->
        <div class="code-area">
            <div class="code-section">
                <div class="code-header">
                    <span>üìù</span>
                    <span>Obfuscated Code</span>
                </div>
                <textarea id="inputCode" placeholder="Paste obfuscated Lua code here..."></textarea>
            </div>
            <div class="code-section">
                <div class="code-header">
                    <span>üëÅÔ∏è</span>
                    <span>Deobfuscated Code</span>
                </div>
                <textarea id="outputCode" class="output-area" placeholder="Deobfuscated code will appear here..." readonly></textarea>
            </div>
        </div>

        <!-- Logs Panel -->
        <div class="logs-panel">
            <div class="logs-header">
                <span>üìã</span>
                <span>Processing Logs</span>
            </div>
            <div class="logs-content" id="logsContent">
                <div class="log-entry">No logs yet...</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Supports: String decryption, constant folding, control flow analysis, dead code removal & more</p>
        </div>
    </div>

    <script>
        // State management
        const state = {
            methods: {
                constantUnfolding: true,
                stringDecryption: true,
                controlFlowSimplification: true,
                deadCodeElimination: true,
                variableRenaming: true,
                expressionSimplification: true,
                tableReconstruction: true,
                callChainFlattening: true
            },
            processing: false,
            logs: []
        };

        // DOM Elements
        const elements = {
            inputCode: document.getElementById('inputCode'),
            outputCode: document.getElementById('outputCode'),
            fileInput: document.getElementById('fileInput'),
            processBtn: document.getElementById('processBtn'),
            processBtnText: document.getElementById('processBtnText'),
            downloadBtn: document.getElementById('downloadBtn'),
            clearBtn: document.getElementById('clearBtn'),
            logsContent: document.getElementById('logsContent'),
            methodsGrid: document.getElementById('methodsGrid')
        };

        // Initialize methods checkboxes
        function initializeMethods() {
            const methodNames = {
                constantUnfolding: 'Constant Unfolding',
                stringDecryption: 'String Decryption',
                controlFlowSimplification: 'Control Flow Simplification',
                deadCodeElimination: 'Dead Code Elimination',
                variableRenaming: 'Variable Renaming',
                expressionSimplification: 'Expression Simplification',
                tableReconstruction: 'Table Reconstruction',
                callChainFlattening: 'Call Chain Flattening'
            };

            Object.keys(state.methods).forEach(key => {
                const div = document.createElement('div');
                div.className = 'method-item';
                div.innerHTML = `
                    <input type="checkbox" id="${key}" ${state.methods[key] ? 'checked' : ''}>
                    <label for="${key}" style="cursor: pointer; user-select: none;">${methodNames[key]}</label>
                `;
                div.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = div.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                        state.methods[key] = checkbox.checked;
                    } else {
                        state.methods[key] = e.target.checked;
                    }
                };
                elements.methodsGrid.appendChild(div);
            });
        }

        // Logging
        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const log = `[${time}] ${message}`;
            state.logs.push({ message: log, type });
            updateLogsDisplay();
        }

        function updateLogsDisplay() {
            if (state.logs.length === 0) {
                elements.logsContent.innerHTML = '<div class="log-entry">No logs yet...</div>';
            } else {
                elements.logsContent.innerHTML = state.logs.map(log => 
                    `<div class="log-entry ${log.type}">${log.message}</div>`
                ).join('');
                elements.logsContent.scrollTop = elements.logsContent.scrollHeight;
            }
        }

        // Deobfuscation Methods
        function decryptStrings(code) {
            // Pattern 1: string.char concatenation
            code = code.replace(/string\.char\(([\d\s,]+)\)/g, (match, codes) => {
                try {
                    const chars = codes.split(',').map(c => String.fromCharCode(parseInt(c.trim())));
                    return `"${chars.join('')}"`;
                } catch (e) {
                    return match;
                }
            });

            // Pattern 2: Byte arrays
            code = code.replace(/\{([\d\s,]+)\}/g, (match, codes) => {
                const nums = codes.split(',').map(n => parseInt(n.trim())).filter(n => n >= 32 && n <= 126);
                if (nums.length > 3 && nums.every(n => !isNaN(n))) {
                    return `"${nums.map(n => String.fromCharCode(n)).join('')}"`;
                }
                return match;
            });

            // Pattern 3: loadstring patterns
            code = code.replace(/loadstring\(([^)]+)\)/g, 'function $1 end');

            return code;
        }

        function unfoldConstants(code) {
            // Simple arithmetic
            code = code.replace(/(\d+)\s*\+\s*(\d+)/g, (m, a, b) => parseInt(a) + parseInt(b));
            code = code.replace(/(\d+)\s*-\s*(\d+)/g, (m, a, b) => Math.max(0, parseInt(a) - parseInt(b)));
            code = code.replace(/(\d+)\s*\*\s*(\d+)/g, (m, a, b) => parseInt(a) * parseInt(b));
            
            // Boolean constants
            code = code.replace(/true\s*and\s*true/g, 'true');
            code = code.replace(/false\s*or\s*true/g, 'true');
            code = code.replace(/true\s*or\s*false/g, 'true');
            code = code.replace(/false\s*and\s*\w+/g, 'false');
            
            return code;
        }

        function simplifyExpressions(code) {
            // Remove unnecessary parentheses
            code = code.replace(/\(\(([^()]+)\)\)/g, '($1)');
            
            // Simplify not not
            code = code.replace(/not\s+not\s+/g, '');
            
            // Simplify double negation
            code = code.replace(/--(\d+)/g, '$1');
            
            // String concatenation
            code = code.replace(/"([^"]*)"\s*\.\.\s*"([^"]*)"/g, '"$1$2"');
            
            return code;
        }

        function simplifyControlFlow(code) {
            // Remove always-true if statements
            code = code.replace(/if\s+true\s+then\s*\n([\s\S]*?)end/g, '$1');
            
            // Remove always-false if statements
            code = code.replace(/if\s+false\s+then\s*\n[\s\S]*?end/g, '');
            
            // Mark infinite loops
            code = code.replace(/while\s+true\s+do/g, 'while true do -- Infinite loop');
            
            return code;
        }

        function removeDeadCode(code) {
            // Remove empty functions
            code = code.replace(/function\s+\w+\s*\([^)]*\)\s*end/g, '');
            
            return code;
        }

        function renameVariables(code) {
            const obfuscatedPatterns = [
                /\b[lI1O0]{3,}\b/g,
                /\b_[A-Z0-9]{5,}\b/g,
                /\b[a-z]_[0-9]{3,}\b/g
            ];
            
            let counter = 0;
            const replacements = new Map();
            
            obfuscatedPatterns.forEach(pattern => {
                const matches = [...code.matchAll(pattern)];
                matches.forEach(match => {
                    const obfVar = match[0];
                    if (!replacements.has(obfVar) && !['local', 'function', 'end', 'if', 'then', 'else'].includes(obfVar)) {
                        replacements.set(obfVar, `var_${counter++}`);
                    }
                });
            });
            
            replacements.forEach((newName, oldName) => {
                const regex = new RegExp(`\\b${oldName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`, 'g');
                code = code.replace(regex, newName);
            });
            
            return code;
        }

        function reconstructTables(code) {
            // Simplify table assignments
            code = code.replace(/local\s+(\w+)\s*=\s*\{\}\s*\n(\s*\1\[["'](\w+)["']\]\s*=\s*[^;\n]+\s*\n)+/g, (match, tableName) => {
                const lines = match.trim().split('\n').slice(1);
                const entries = lines.map(line => {
                    const keyMatch = line.match(/\["?'?(\w+)"?'?\]\s*=\s*(.+)/);
                    if (keyMatch) {
                        return `  ${keyMatch[1]} = ${keyMatch[2].trim()}`;
                    }
                    return line;
                });
                return `local ${tableName} = {\n${entries.join(',\n')}\n}`;
            });
            
            return code;
        }

        function flattenCallChains(code) {
            // Simplify nested function calls
            code = code.replace(/\(\s*function\s*\([^)]*\)\s*return\s+([^end]+)\s+end\s*\)\s*\(/g, '($1)(');
            
            return code;
        }

        function beautifyLua(code) {
            let indentLevel = 0;
            const indentSize = 2;
            
            const lines = code.split('\n').map(line => {
                line = line.trim();
                if (!line) return '';
                
                // Decrease indent
                if (/^(end|else|elseif|until)\b/.test(line)) {
                    indentLevel = Math.max(0, indentLevel - 1);
                }
                
                const indented = ' '.repeat(indentLevel * indentSize) + line;
                
                // Increase indent
                if (/\b(then|do|repeat|else)\s*$/.test(line) || /^function\b/.test(line)) {
                    indentLevel++;
                }
                
                return indented;
            });
            
            return lines.join('\n');
        }

        // Main deobfuscation function
        function deobfuscate(code) {
            addLog('Starting deobfuscation process...', 'info');
            let result = code;

            if (state.methods.stringDecryption) {
                addLog('Applying string decryption...', 'info');
                result = decryptStrings(result);
            }

            if (state.methods.constantUnfolding) {
                addLog('Unfolding constants...', 'info');
                result = unfoldConstants(result);
            }

            if (state.methods.expressionSimplification) {
                addLog('Simplifying expressions...', 'info');
                result = simplifyExpressions(result);
            }

            if (state.methods.controlFlowSimplification) {
                addLog('Simplifying control flow...', 'info');
                result = simplifyControlFlow(result);
            }

            if (state.methods.deadCodeElimination) {
                addLog('Removing dead code...', 'info');
                result = removeDeadCode(result);
            }

            if (state.methods.variableRenaming) {
                addLog('Renaming obfuscated variables...', 'info');
                result = renameVariables(result);
            }

            if (state.methods.tableReconstruction) {
                addLog('Reconstructing tables...', 'info');
                result = reconstructTables(result);
            }

            if (state.methods.callChainFlattening) {
                addLog('Flattening call chains...', 'info');
                result = flattenCallChains(result);
            }

            addLog('Beautifying code...', 'info');
            result = beautifyLua(result);

            addLog('‚úì Deobfuscation complete!', 'success');
            return result;
        }

        // Event Handlers
        elements.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                elements.inputCode.value = event.target.result;
                state.logs = [];
                addLog(`Loaded file: ${file.name}`, 'info');
            };
            reader.readAsText(file);
        });

        elements.processBtn.addEventListener('click', () => {
            if (!elements.inputCode.value.trim()) {
                state.logs = [];
                addLog('Error: Please provide input code', 'error');
                return;
            }

            state.processing = true;
            state.logs = [];
            elements.processBtn.disabled = true;
            elements.processBtnText.innerHTML = '<span class="spinner"></span> Processing...';

            setTimeout(() => {
                try {
                    const result = deobfuscate(elements.inputCode.value);
                    elements.outputCode.value = result;
                    elements.downloadBtn.disabled = false;
                } catch (error) {
                    addLog(`Error: ${error.message}`, 'error');
                    elements.outputCode.value = '-- Deobfuscation failed. Check logs for details.';
                }
                
                state.processing = false;
                elements.processBtn.disabled = false;
                elements.processBtnText.textContent = 'Deobfuscate';
            }, 100);
        });

        elements.downloadBtn.addEventListener('click', () => {
            const blob = new Blob([elements.outputCode.value], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'deobfuscated.lua';
            a.click();
            URL.revokeObjectURL(url);
            addLog('File downloaded successfully', 'success');
        });

        elements.clearBtn.addEventListener('click', () => {
            elements.inputCode.value = '';
            elements.outputCode.value = '';
            state.logs = [];
            updateLogsDisplay();
            elements.downloadBtn.disabled = true;
        });

        // Initialize
        initializeMethods();
    </script>
</body>
</html>
