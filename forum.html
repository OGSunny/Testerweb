<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaratic Role Play - ფორუმი</title>

    <link rel="icon" href="https://raw.githubusercontent.com/OGSunny/Testerweb/main/zaratic.png" type="image/png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

    <script src="https://www.google.com/recaptcha/api.js?render=6Leb8hssAAAAAI8gLARQyLz_91BRCNM1TEMdU6YR"></script>

    <style>
        /* საბაზისო კონფიგურაცია / Base Configuration */
        :root {
            --color-primary-start: #00ffff;
            --color-primary-end: #0066ff;
            --transition-speed: 0.4s;
            --bezier: cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            overflow-x: hidden;
            color: white;
        }

        /* ანიმაციები / Animations */
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up-custom {
            animation: fadeIn 0.5s ease-out;
        }

        /* სტილები / Styles */
        .glass-card {
            backdrop-filter: blur(15px) saturate(180%);
            background: rgba(14, 23, 34, 0.7);
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(0, 255, 255, 0.1);
            transition: all var(--transition-speed) var(--bezier);
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6), 0 0 40px rgba(0, 255, 255, 0.4);
            border-color: rgba(0, 255, 255, 0.6);
        }

        .btn-gradient {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, var(--color-primary-start), var(--color-primary-end), var(--color-primary-start));
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 255, 255, 0.4);
            color: #070d14;
            font-weight: 700;
        }

        .btn-gradient:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.6);
        }

        .btn-secondary {
            background: rgba(14, 23, 34, 0.8);
            border: 1px solid #00ffff;
            color: #00ffff;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: rgba(0, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .animated-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2;
            background: radial-gradient(circle at 10% 20%, #0c141d, #0d1117 70%);
        }

        .gradient-text {
            background-image: linear-gradient(45deg, #00ffff, #0066ff, #79ff70);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* სკროლი / Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #070d14; }
        ::-webkit-scrollbar-thumb { background: #0066ff; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00ffff; }

        .skeleton {
            background: linear-gradient(90deg, #1f2a37 25%, #293847 50%, #1f2a37 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }
    </style>
</head>
<body class="min-h-screen text-gray-100 selection:bg-cyan-500 selection:text-black">
    
    <div class="animated-bg"></div>

    <nav class="sticky top-0 z-40 p-4 border-b border-cyan-500/20 glass-card rounded-b-xl backdrop-blur-xl">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.reload()">
                <img src="https://raw.githubusercontent.com/OGSunny/Testerweb/main/zaratic.png" class="h-10 w-10 border-2 border-cyan-400 rounded hover:rotate-6 transition-transform duration-300">
                <h1 class="text-2xl font-extrabold tracking-widest gradient-text hidden sm:block">Zaratic RP</h1>
            </div>
            
            <div id="navActions" class="flex items-center gap-4">
                </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8 relative min-h-[80vh]">
        
        <div id="mainLoading" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
            <div class="text-cyan-400 text-xl font-bold flex items-center gap-3">
                <i class="fas fa-circle-notch fa-spin text-3xl"></i> დამუშავება...
            </div>
        </div>

        <div id="forumView" class="animate-fade-in-up-custom">
            <header class="py-8 text-center">
                <h2 class="text-4xl md:text-5xl font-black mb-2 gradient-text">Zaratic Role Play</h2>
                <p class="text-cyan-200/60 font-mono text-sm">ოფიციალური კომუნიკაციის პროტოკოლები და არქივები</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                
                <div class="glass-card p-6 rounded-2xl group">
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b border-white/10">
                        <i class="fas fa-server text-cyan-400 text-xl"></i>
                        <h3 class="text-xl font-bold text-cyan-100">სერვერის საერთო სიახლეები</h3>
                    </div>
                    <div class="space-y-3">
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="rules" data-view-only="true">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-book-open mr-2 text-cyan-500"></i> სერვერის წესები</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="news" data-view-only="true">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-broadcast-tower mr-2 text-cyan-500"></i> სერვერის განახლებები</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-2xl group">
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b border-white/10">
                        <i class="fas fa-info-circle text-cyan-400 text-xl"></i>
                        <h3 class="text-xl font-bold text-cyan-100">საინფორმაციო განყოფილება</h3>
                    </div>
                    <div class="space-y-3">
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="suggestions">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-lightbulb mr-2 text-cyan-500"></i> შემოთავაზებები</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="events">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-calendar-check mr-2 text-cyan-500"></i> ღონისძიებები</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="biographies">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-id-card mr-2 text-cyan-500"></i> RP ბიოგრაფიები</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-2xl group">
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b border-white/10">
                        <i class="fas fa-gavel text-orange-400 text-xl"></i>
                        <h3 class="text-xl font-bold text-cyan-100">საჩივრები</h3>
                    </div>
                    <div class="space-y-3">
                         <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="complaints-admin">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-user-lock mr-2 text-orange-400"></i> საჩივრები ადმინისტრატორზე</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="complaints-player">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-user-times mr-2 text-orange-400"></i> საჩივრები მოთამაშეზე</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="unban">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-key mr-2 text-green-400"></i> სასჯელის შემცირება/შეწყალება</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-2xl group">
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b border-white/10">
                        <i class="fas fa-briefcase text-cyan-400 text-xl"></i>
                        <h3 class="text-xl font-bold text-cyan-100">ვაკანსიები</h3>
                    </div>
                    <div class="space-y-3">
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="vacancies-leaders">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-chess-king mr-2 text-cyan-500"></i> ვაკანსია ლიდერებზე</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="vacancies-admin">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-shield-alt mr-2 text-cyan-500"></i> ვაკანსია ადმინისტრაციაზე</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="vacancies-partner">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-handshake mr-2 text-cyan-500"></i> ვაკანსია პარტნიორობაზე</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-2xl group col-span-1 md:col-span-2 lg:col-span-1">
                    <div class="flex items-center gap-3 mb-4 pb-3 border-b border-white/10">
                        <i class="fas fa-cogs text-cyan-400 text-xl"></i>
                        <h3 class="text-xl font-bold text-cyan-100">ტექნიკური განყოფილება</h3>
                    </div>
                    <div class="space-y-3">
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="donation-help">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-hand-holding-usd mr-2 text-cyan-500"></i> დახმარება დონაციაზე</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                        <a href="#" class="section-link block p-3 rounded-lg hover:bg-white/5 transition-all border border-transparent hover:border-cyan-500/30" data-section="general">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium"><i class="fas fa-comments mr-2 text-cyan-500"></i> დახმარება ტექნიკურ საკითხებზე</span>
                                <span class="sec-stats bg-cyan-900/50 text-cyan-400 text-xs px-2 py-1 rounded border border-cyan-500/30">0</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div id="sectionView" class="hidden animate-fade-in-up-custom">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <button onclick="backToForumFromSection()" class="btn-secondary px-4 py-2 rounded-lg text-sm mb-2 flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> უკან
                    </button>
                    <h2 id="sectionTitle" class="text-3xl font-extrabold gradient-text"></h2>
                    <div id="sectionBreadcrumbs" class="text-sm text-gray-400 mt-1 font-mono"></div>
                </div>
                <button onclick="openFormModalForCurrentSection()" id="createThreadBtn" class="btn-gradient px-6 py-2 rounded-lg shadow-lg flex items-center gap-2">
                    <span class="relative z-10"><i class="fas fa-plus"></i> ახალი მოთხოვნა</span>
                </button>
            </div>

            <div id="threadsList" class="space-y-4">
                </div>
        </div>

        <div id="threadView" class="hidden animate-fade-in-up-custom">
            <div class="flex justify-between items-center mb-6">
                <button onclick="backToSectionFromThread()" class="btn-secondary px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> სექციაში დაბრუნება
                </button>
            </div>

            <div class="glass-card p-6 rounded-2xl mb-8">
                <h2 id="threadTitle" class="text-3xl font-extrabold mb-2 gradient-text"></h2>
                <div id="threadBreadcrumbs" class="text-sm text-gray-400 font-mono"></div>
            </div>

            <div id="threadPosts" class="space-y-6">
                </div>

            <div class="glass-card p-6 md:p-8 rounded-2xl my-10">
                <h3 class="text-xl font-bold mb-4 text-cyan-100">პასუხის დაწერა</h3>
                <form id="newReplyForm">
                    <textarea id="replyContent" rows="4" class="w-full p-4 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:ring-2 focus:ring-cyan-500 transition-all text-gray-100 placeholder-gray-500" placeholder="დაწერეთ თქვენი პასუხი აქ..." required></textarea>
                    <div class="mt-4 flex justify-end">
                        <button type="submit" id="submitReplyBtn" class="btn-gradient px-6 py-3 rounded-lg font-bold flex items-center gap-2">
                            <span class="relative z-10"><i class="fas fa-paper-plane"></i> პასუხის გაგზავნა</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="profileView" class="hidden animate-fade-in-up-custom">
            <div class="glass-card p-8 rounded-3xl max-w-4xl mx-auto border-l-4 border-cyan-400">
                <div class="flex flex-col md:flex-row items-center gap-8 mb-8 pb-8 border-b border-gray-700/50">
                    <div id="profileAvatarLarge" class="w-32 h-32 rounded-full border-4 border-cyan-400 shadow-[0_0_20px_rgba(0,255,255,0.4)] flex items-center justify-center text-4xl font-bold bg-gray-800"></div>
                    <div class="text-center md:text-left">
                        <h2 id="profileUsername" class="text-4xl font-black gradient-text mb-2"></h2>
                        <div id="profileBadges" class="flex flex-wrap gap-2 justify-center md:justify-start"></div>
                    </div>
                </div>

                <div class="flex gap-4 border-b border-gray-700/50 mb-6">
                    <button class="px-4 py-2 text-cyan-400 border-b-2 border-cyan-400 font-bold tab-btn" onclick="switchTab('info', this)">ინფორმაცია</button>
                    <button class="px-4 py-2 text-gray-400 hover:text-cyan-200 tab-btn" onclick="switchTab('edit', this)">რედაქტირება</button>
                    <button id="adminTabBtn" class="px-4 py-2 text-red-400 hover:text-red-300 hidden tab-btn" onclick="switchTab('admin', this)">ადმინი</button>
                </div>

                <div id="infoTab" class="tab-content grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gray-900/40 p-4 rounded-xl border border-gray-700">
                        <label class="block text-xs text-cyan-500 font-mono mb-1">ჩვენების სახელი</label>
                        <div id="displayName" class="text-lg">-</div>
                    </div>
                    <div class="bg-gray-900/40 p-4 rounded-xl border border-gray-700">
                        <label class="block text-xs text-cyan-500 font-mono mb-1">ელფოსტა</label>
                        <div id="displayEmail" class="text-lg">-</div>
                    </div>
                    <div class="bg-gray-900/40 p-4 rounded-xl border border-gray-700">
                        <label class="block text-xs text-cyan-500 font-mono mb-1">ტელეფონი</label>
                        <div id="displayPhone" class="text-lg">-</div>
                    </div>
                    <div class="bg-gray-900/40 p-4 rounded-xl border border-gray-700 md:col-span-2">
                        <label class="block text-xs text-cyan-500 font-mono mb-1">ბიოგრაფია</label>
                        <div id="displayBio" class="text-lg italic text-gray-300">-</div>
                    </div>
                </div>

                <div id="editTab" class="hidden tab-content">
                    <form id="profileEditForm" class="space-y-4">
                        <div>
                            <label class="block text-sm mb-1 text-gray-400">ავატარი (ფაილი)</label>
                            <div class="flex items-center gap-4">
                                <div id="avatarPreview" class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center border border-cyan-500/50 bg-cover bg-center"></div>
                                <input type="file" id="editAvatar" class="text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-900/50 file:text-cyan-400 hover:file:bg-cyan-900" accept="image/*" onchange="previewAvatar(this)">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="editName" placeholder="ჩვენების სახელი" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none">
                            <input type="email" id="editEmail" placeholder="ელფოსტა" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none">
                            <input type="tel" id="editPhone" placeholder="ტელეფონი" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none">
                        </div>
                        <input type="text" id="editBio" placeholder="ბიოგრაფია" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none">
                        <button type="submit" id="saveProfileBtn" class="btn-gradient px-6 py-2 rounded-lg mt-4"><span class="relative z-10">ცვლილებების შენახვა</span></button>
                    </form>
                </div>

                <div id="adminTab" class="hidden tab-content space-y-6">
                    <div class="p-6 rounded-xl bg-gray-900/50 border border-cyan-900">
                        <h4 class="text-cyan-400 font-bold mb-4">ბეჯის მინიჭება</h4>
                        <div class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="badgeUsername" placeholder="მომხმარებელი" class="flex-1 p-2 bg-black/50 border border-gray-700 rounded">
                            <input type="text" id="badgeName" placeholder="ბეჯი (მაგ: VIP)" class="flex-1 p-2 bg-black/50 border border-gray-700 rounded">
                            <button onclick="assignBadge(event)" class="btn-gradient px-4 py-2 rounded"><span class="relative z-10">დამატება</span></button>
                        </div>
                    </div>
                    <div class="p-6 rounded-xl bg-gray-900/50 border border-red-900/30">
                        <h4 class="text-orange-400 font-bold mb-4">ბეჯის წაშლა</h4>
                        <div class="flex flex-col md:flex-row gap-4">
                            <input type="text" id="removeBadgeUsername" placeholder="მომხმარებელი" class="flex-1 p-2 bg-black/50 border border-gray-700 rounded">
                            <input type="text" id="removeBadgeName" placeholder="ბეჯის სახელი" class="flex-1 p-2 bg-black/50 border border-gray-700 rounded">
                            <button onclick="removeBadge(event)" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded text-white font-bold transition">წაშლა</button>
                        </div>
                    </div>
                </div>

                <button onclick="backToForum()" class="mt-8 text-gray-400 hover:text-white flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> მთავარ გვერდზე დაბრუნება
                </button>
            </div>
        </div>
    </main>

    <div id="modalContainer" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md hidden opacity-0 transition-opacity duration-300">
        <div id="modalContent" class="glass-card w-full max-w-lg p-8 rounded-2xl scale-95 transition-transform duration-300 relative">
            <button onclick="closeActiveModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            
            <div id="dynamicModalBody"></div>
        </div>
    </div>

    <div id="toast" class="fixed top-24 right-5 z-50 px-6 py-4 rounded-lg shadow-2xl transform translate-x-full transition-transform duration-300 font-bold flex items-center gap-3"></div>

    <script>
        const FORUM_API_BASE_URL = 'https://data7167.jemalagegidze.workers.dev';
        emailjs.init('uQH9b9PES4f2ONCNq');

        // გლობალური ცვლადები / Global Variables
        let currentUser = null; 
        let userData = null;    
        let currentSection = null;
        let currentThread = null;
        let sectionPosts = [];
        let refreshInterval = null;
        const storageKey = 'zaraticForum_v2';
        let localData = JSON.parse(localStorage.getItem(storageKey)) || { token: null };

        // ქართული თარიღები / Georgian Date Setup
        const georgianMonths = [
            'იანვარი', 'თებერვალი', 'მარტი', 'აპრილი',
            'მაისი', 'ივნისი', 'ივლისი', 'აგვისტო',
            'სექტემბერი', 'ოქტომბერი', 'ნოემბერი', 'დეკემბერი'
        ];

        /* --- დამხმარე ფუნქციები / Utilities --- */
        
        function showLoading(show) {
            document.getElementById('mainLoading').classList.toggle('hidden', !show);
        }

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed top-24 right-5 z-50 px-6 py-4 rounded-lg shadow-2xl transition-transform duration-300 font-bold flex items-center gap-3 transform ${type === 'success' ? 'bg-gradient-to-r from-green-600 to-green-800 text-white' : 'bg-gradient-to-r from-orange-600 to-red-800 text-white'}`;
            
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            return text.replace(/[&<>"']/g, function(m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
            });
        }

        function formatGeorgianDate(timestamp) {
            const date = new Date(timestamp);
            const day = date.getDate();
            const monthIndex = date.getMonth();
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');

            // Format: "5 დეკემბერი, 14:30"
            return `${day} ${georgianMonths[monthIndex]}, ${hours}:${minutes}`;
        }

        function formatTimeRelative(time) {
            const diff = Date.now() - time;
            const s = 1000;
            const m = 60 * s;
            const h = 60 * m;
            const d = 24 * h;
            
            if (diff < m) return 'ახლა';
            if (diff < h) return `${Math.floor(diff/m)} წთ წინ`;
            if (diff < d) return `${Math.floor(diff/h)} სთ წინ`;
            if (diff < 7 * d) return `${Math.floor(diff/d)} დღის წინ`;
            return formatGeorgianDate(time); 
        }

        function getBadgeHtml(name) {
            const safeName = escapeHtml(name).toUpperCase();
            const colors = {
                'ADMIN': 'bg-gradient-to-r from-cyan-400 to-blue-600 text-black',
                'VIP': 'bg-gradient-to-r from-yellow-400 to-orange-500 text-black',
                'MODERATOR': 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white',
                'HELPER': 'bg-gradient-to-r from-green-400 to-emerald-600 text-black',
                'OWNER': 'bg-gradient-to-r from-red-500 to-red-800 text-white'
            };
            const cls = colors[safeName] || 'bg-gray-700 text-white';
            return `<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider badge-custom ${cls}">${safeName}</span>`;
        }

        /* --- API კავშირი / API Layer --- */

        async function api(path, options = {}) {
            showLoading(true);
            const headers = { ...options.headers };
            
            if (options.body && !(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }

            if (localData.token) headers['Authorization'] = `Bearer ${localData.token}`;

            try {
                const res = await fetch(FORUM_API_BASE_URL + path, { ...options, headers });
                showLoading(false);
                
                if (res.status === 401 || res.status === 403) {
                     if (!['/me','/login','/register','/verify'].includes(path) && currentUser) {
                        // თუ სესია ვადაგასულია
                        showToast('სესია ვადაგასულია. გთხოვთ გაიაროთ ავტორიზაცია.', 'error');
                        logout();
                     }
                     // Let specific handlers deal with 403 (banned)
                     return res; 
                }
                
                if (!res.ok) { 
                    if (path !== '/post-counts') { 
                        let errData = { message: res.statusText || 'Unknown Error' };
                        try {
                            const clone = res.clone();
                            if (res.headers.get('content-type')?.includes('application/json')) {
                                errData = await clone.json();
                            }
                        } catch(e) {}
                        showToast(errData.message || 'ოპერაცია ვერ შესრულდა', 'error');
                    }
                }
                return res;
            } catch (err) {
                showLoading(false);
                console.error('API Error:', err);
                showToast('კავშირის შეცდომა', 'error');
                return null;
            }
        }

        /* --- მოდალური ფანჯრები / Modals --- */

        function openModal(htmlContent) {
            const container = document.getElementById('modalContainer');
            const content = document.getElementById('modalContent');
            const body = document.getElementById('dynamicModalBody');
            
            body.innerHTML = htmlContent;
            container.classList.remove('hidden');
            setTimeout(() => {
                container.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeActiveModal() {
            const container = document.getElementById('modalContainer');
            const content = document.getElementById('modalContent');
            
            container.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            
            setTimeout(() => container.classList.add('hidden'), 300);
        }

        function showWelcomeModal() {
            if(currentUser) return;
            openModal(`
                <div class="text-center">
                    <h2 class="text-3xl font-black gradient-text mb-4">წვდომა შეზღუდულია</h2>
                    <p class="text-gray-300 mb-6">თქვენ იმყოფებით სტუმრის სტატუსით. გასაგრძელებლად გაიარეთ ავტორიზაცია.</p>
                    <div class="flex flex-col gap-3">
                        <button onclick="showLogin()" class="btn-gradient w-full py-3 rounded-lg"><span class="relative z-10">შესვლა (LOGIN)</span></button>
                        <button onclick="showRegister()" class="btn-secondary w-full py-3 rounded-lg">რეგისტრაცია (REGISTER)</button>
                    </div>
                </div>
            `);
        }

        function showLogin() {
            openModal(`
                <h2 class="text-2xl font-bold text-cyan-400 mb-4">ავტორიზაცია</h2>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <input type="text" id="loginUsername" placeholder="მომხმარებელი" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none text-white" required>
                    <input type="password" id="loginPassword" placeholder="პაროლი" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none text-white" required>
                    <input type="hidden" id="loginRecaptchaToken">
                    <button type="submit" class="btn-gradient w-full py-2 rounded-lg mt-2"><span class="relative z-10">შესვლა</span></button>
                    <p class="text-center text-xs text-gray-500 mt-2 cursor-pointer hover:text-cyan-400" onclick="showRegister()">არ გაქვთ ანგარიში? რეგისტრაცია</p>
                </form>
            `);
        }

        function showRegister() {
            openModal(`
                <h2 class="text-2xl font-bold text-cyan-400 mb-4">რეგისტრაცია</h2>
                <form onsubmit="handleRegister(event)" class="space-y-4">
                    <input type="text" id="regUsername" placeholder="მომხმარებელი (3-20 სიმბოლო)" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none text-white" pattern="^[a-zA-Z0-9_]{3,20}$" title="Username must be 3-20 characters long and contain only letters, numbers, and underscores." required>
                    <input type="email" id="regEmail" placeholder="ელფოსტა" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none text-white" required>
                    <input type="password" id="regPassword" placeholder="პაროლი (მინ. 8 სიმბოლო)" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none text-white" required>
                    <input type="hidden" id="regRecaptchaToken">
                    <button type="submit" class="btn-gradient w-full py-2 rounded-lg mt-2"><span class="relative z-10">რეგისტრაცია</span></button>
                </form>
            `);
        }

        function showVerify() {
            openModal(`
                <h2 class="text-2xl font-bold text-green-400 mb-4">ელფოსტის დადასტურება</h2>
                <p class="text-sm text-gray-400 mb-4">კოდი გამოგზავნილია თქვენს ელფოსტაზე.</p>
                <form onsubmit="handleVerify(event)" class="space-y-4">
                    <input type="text" id="verifyCode" placeholder="8-ნიშნა კოდი" maxlength="8" class="w-full p-3 bg-gray-900/50 rounded-lg border border-green-500/30 focus:border-green-400 outline-none text-center tracking-widest text-xl font-mono" required>
                    <button type="submit" class="btn-gradient w-full py-2 rounded-lg"><span class="relative z-10">დადასტურება</span></button>
                </form>
            `);
        }

        function showNewThreadModal() {
            if (!currentUser) return showLogin();
            
            const sectionEl = document.querySelector(`a[data-section="${currentSection}"]`);
            if (sectionEl?.dataset.viewOnly === 'true' && userData?.role !== 'admin') {
                return showToast('მხოლოდ ადმინს შეუძლია ამ სექციაში წერა', 'error');
            }

            openModal(`
                <h2 class="text-2xl font-bold gradient-text mb-4">ახალი თემა</h2>
                <form onsubmit="handleNewThread(event)" class="space-y-4">
                    <input type="text" id="threadTitleInput" placeholder="თემა (სათაური)" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required maxlength="100">
                    <textarea id="threadContent" rows="5" placeholder="ტექსტი..." class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required></textarea>
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeActiveModal()" class="text-gray-400 hover:text-white px-4">გაუქმება</button>
                        <button type="submit" id="submitThreadBtn" class="btn-gradient px-6 py-2 rounded-lg"><span class="relative z-10">გამოქვეყნება</span></button>
                    </div>
                </form>
            `);
        }

        /* --- RECAPTCHA HELPER (FIXED) --- */
        
        async function getRecaptchaToken(action) {
            // Check if reCAPTCHA is loaded
            if (typeof grecaptcha === 'undefined') {
                console.error('reCAPTCHA not loaded!');
                throw new Error('reCAPTCHA not loaded');
            }
            
            return new Promise((resolve, reject) => {
                try {
                    grecaptcha.ready(function() {
                        grecaptcha.execute('6Leb8hssAAAAAI8gLARQyLz_91BRCNM1TEMdU6YR', { action: action })
                            .then(function(token) {
                                if (!token) {
                                    reject(new Error('Empty token received'));
                                } else {
                                    resolve(token);
                                }
                            })
                            .catch(function(error) {
                                console.error('reCAPTCHA execute failed:', error);
                                reject(error);
                            });
                    });
                } catch (error) {
                    console.error('reCAPTCHA error:', error);
                    reject(error);
                }
            });
        }


        /* --- ავტორიზაციის ლოგიკა / Auth Handlers (FIXED) --- */

        async function handleLogin(e) {
            e.preventDefault();
            
            let recaptchaToken;
            try {
                // 1. Get reCAPTCHA token safely
                recaptchaToken = await getRecaptchaToken('login');
                document.getElementById('loginRecaptchaToken').value = recaptchaToken; // For visibility/debugging
            } catch (error) {
                console.error('reCAPTCHA failed:', error);
                showToast('უსაფრთხოების შემოწმება ვერ ჩაიტვირთა. გთხოვთ განაახლოთ გვერდი.', 'error');
                return; // STOP EXECUTION
            }
            
            const u = document.getElementById('loginUsername').value.trim();
            const p = document.getElementById('loginPassword').value;
            
            // 2. Send token to backend
            const res = await api('/login', { 
                method: 'POST', 
                body: JSON.stringify({
                    username: u, 
                    password: p,
                    recaptchaToken: recaptchaToken // Send token to backend
                })
            });
            
            if(res && res.ok) {
                const data = await res.json();
                finishAuth(data);
                closeActiveModal();
                showToast(`მოგესალმებით, ${u}`);
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            let recaptchaToken;
            try {
                // 1. Get reCAPTCHA token safely
                recaptchaToken = await getRecaptchaToken('register');
                document.getElementById('regRecaptchaToken').value = recaptchaToken; // For visibility/debugging
            } catch (error) {
                console.error('reCAPTCHA failed:', error);
                showToast('უსაფრთხოების შემოწმება ვერ ჩაიტვირთა. გთხოვთ განაახლოთ გვერდი.', 'error');
                return; // STOP EXECUTION
            }

            const u = document.getElementById('regUsername').value.trim();
            const em = document.getElementById('regEmail').value.trim();
            const p = document.getElementById('regPassword').value;

            if (p.length < 8) return showToast('პაროლი უნდა იყოს მინიმუმ 8 სიმბოლო.', 'error');
            if (!/^[a-zA-Z0-9_]{3,20}$/.test(u)) return showToast('მომხმარებლის სახელი არასწორია.', 'error');

            const code = String(Math.floor(10000000 + Math.random() * 90000000));
            const submitBtn = document.getElementById('dynamicModalBody').querySelector('button[type="submit"]');
            
            try {
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'იგზავნება...';

    // Send email with EmailJS
    await emailjs.send('service_ctcaqad', 'template_nwsmd5p', { 
        to_email: em,     // Matches {{to_email}}
        to_name: u,       // Matches {{to_name}}
        code: code,       // Matches {{code}} - ✅ COMMA ADDED
        email: em         // Matches {{email}} in Reply To field
    });
    
    // Then register with backend
    const res = await api('/register', { 
        method: 'POST', 
        body: JSON.stringify({
            username: u, 
            email: em, 
            password: p, 
            code,
            recaptchaToken: recaptchaToken
        })
    });
    
    if(res && res.ok) {
        sessionStorage.setItem('pendingEmail', em);
        showVerify();
        showToast('დადასტურების კოდი გაიგზავნა.');
    }
} catch(err) {
    console.error('Email sending error:', err);
    showToast(`ელფოსტის გაგზავნა ვერ მოხერხდა: ${err.text || err.message}`, 'error');
} finally {
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span class="relative z-10">რეგისტრაცია</span>';
    }
}

        async function handleVerify(e) {
            e.preventDefault();
            const code = document.getElementById('verifyCode').value.trim();
            const email = sessionStorage.getItem('pendingEmail');
            
            const res = await api('/verify', { method: 'POST', body: JSON.stringify({email, code})});
            if(res && res.ok) {
                const data = await res.json();
                finishAuth(data);
                closeActiveModal();
                showToast('ვერიფიკაცია წარმატებულია');
                sessionStorage.removeItem('pendingEmail');
            }
        }

        function finishAuth(data) {
            localData.token = data.token;
            currentUser = data.user.username;
            userData = data.user;
            localStorage.setItem(storageKey, JSON.stringify(localData));
            updateUI();
        }

        function logout() {
            localStorage.removeItem(storageKey);
            localData = { token: null };
            currentUser = null;
            userData = null;
            updateUI();
            backToForum();
            clearInterval(refreshInterval);
            showWelcomeModal();
        }

        function updateUI() {
            const nav = document.getElementById('navActions');
            if(currentUser) {
                const avatarUrl = userData.profile.avatar;
                const avatar = avatarUrl 
                    ? `<img src="${escapeHtml(avatarUrl)}" class="w-8 h-8 rounded-full border border-cyan-400 object-cover">`
                    : `<div class="w-8 h-8 rounded-full bg-cyan-900 flex items-center justify-center text-xs font-bold border border-cyan-400">${currentUser[0].toUpperCase()}</div>`;
                
                nav.innerHTML = `
                    <div class="flex items-center gap-2 cursor-pointer glass-card px-3 py-1 rounded-full hover:bg-cyan-900/30 transition" onclick="showProfile()">
                        ${avatar}
                        <span class="text-sm font-semibold hidden sm:inline">${escapeHtml(currentUser)}</span>
                    </div>
                    <button onclick="logout()" class="text-gray-400 hover:text-red-400 transition" title="გამოსვლა"><i class="fas fa-sign-out-alt"></i></button>
                `;
            } else {
                nav.innerHTML = `
                    <button onclick="showLogin()" class="btn-gradient px-4 py-1.5 rounded-lg text-sm"><span class="relative z-10">შესვლა</span></button>
                    <button onclick="showRegister()" class="text-sm text-gray-300 hover:text-white px-2">რეგისტრაცია</button>
                `;
            }
        }
        
        async function fetchPostCounts() {
            if (!currentUser) return;
            const countsRes = await api('/post-counts');
            if(countsRes && countsRes.ok) {
                const counts = await countsRes.json();
                document.querySelectorAll('.section-link').forEach(el => {
                    const c = counts[el.dataset.section] || 0;
                    el.querySelector('.sec-stats').textContent = c;
                });
            }
        }

        /* --- ხედების მართვა / View Controllers --- */

        function switchView(viewId) {
            ['forumView', 'sectionView', 'threadView', 'profileView'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add('hidden');
                el.style.opacity = '0'; 
                if(id === viewId) {
                    el.classList.remove('hidden');
                    setTimeout(() => el.style.opacity = '1', 10);
                }
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function fetchPosts() {
            const res = await api(`/posts/${currentSection}`);
            return (res && res.ok) ? await res.json() : [];
        }

        async function renderThreads() {
            const list = document.getElementById('threadsList');
            if (currentSection === null) return; 

            // Skeleton Loader
            list.innerHTML = `<div class="glass-card p-6 h-32 skeleton rounded-2xl"></div><div class="glass-card p-6 h-32 skeleton rounded-2xl"></div>`;
            
            sectionPosts = await fetchPosts();
            list.innerHTML = ''; 

            const threads = sectionPosts.filter(p => !p.parentId).sort((a,b) => b.pinned - a.pinned || b.time - a.time);
            
            if(threads.length === 0) {
                list.innerHTML = `<div class="text-center text-gray-500 py-10">ამ განყოფილებაში თემები არ არის.</div>`;
                return;
            }

            threads.forEach(thread => {
                const replies = sectionPosts.filter(p => p.parentId === thread.id).length;
                const isPinned = thread.pinned ? 'border-l-4 border-green-400' : '';
                const pinIcon = thread.pinned ? '<i class="fas fa-thumbtack text-green-400 mr-2"></i>' : '';
                
                const card = document.createElement('div');
                card.className = `glass-card p-5 rounded-xl flex flex-col md:flex-row md:items-center justify-between cursor-pointer group ${isPinned}`;
                card.onclick = (e) => { 
                    if(!e.target.closest('button')) openThread(thread.id, thread.title || thread.content.substring(0,30)) 
                };

                card.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-lg font-bold group-hover:text-cyan-400 transition-colors">${pinIcon}${escapeHtml(thread.title || 'Untitled')}</h3>
                        <div class="flex items-center gap-4 text-xs text-gray-400 mt-2 font-mono">
                            <span class="flex items-center gap-1"><i class="fas fa-user"></i> ${escapeHtml(thread.author)}</span>
                            <span class="flex items-center gap-1"><i class="fas fa-clock"></i> ${formatTimeRelative(thread.time)}</span>
                        </div>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center gap-4">
                        <div class="text-right hidden md:block">
                            <div class="text-2xl font-bold text-cyan-600">${replies}</div>
                            <div class="text-[10px] text-gray-500 uppercase">პასუხები</div>
                        </div>
                        ${userData?.role === 'admin' ? `
                            <div class="flex gap-2">
                                <button onclick="togglePin(event, '${thread.id}')" title="პინი/ანპინი" class="p-2 bg-gray-800 rounded hover:bg-green-900/50 text-gray-400 hover:text-green-400 transition"><i class="fas fa-thumbtack"></i></button>
                                <button onclick="deleteThread(event, '${thread.id}')" title="თემის წაშლა" class="p-2 bg-gray-800 rounded hover:bg-red-900/50 text-gray-400 hover:text-red-400 transition"><i class="fas fa-trash"></i></button>
                            </div>
                        ` : ''}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        async function renderThread() {
            if (!currentThread) return;
            sectionPosts = await fetchPosts(); 
            const container = document.getElementById('threadPosts');
            container.innerHTML = '';

            const op = sectionPosts.find(p => p.id === currentThread);
            if(!op) return container.innerHTML = '<div class="text-center text-red-400 py-10">თემა ვერ მოიძებნა.</div>';

            container.appendChild(createPostEl(op, false));

            sectionPosts.filter(p => p.parentId === currentThread)
                .sort((a,b) => a.time - b.time)
                .forEach(p => container.appendChild(createPostEl(p, true)));
        }

        function createPostEl(post, isReply) {
            const div = document.createElement('div');
            const isAuthor = post.author === userData?.username;
            const borderClass = isAuthor ? 'border-cyan-500/30' : 'border-transparent';
            
            const badges = (post.badges || []).map(getBadgeHtml).join(' ');
            const safeAuthor = escapeHtml(post.author);
            const avatarUrl = post.avatar ? escapeHtml(post.avatar) : '';

            const avatar = avatarUrl
                ? `<img src="${avatarUrl}" class="w-12 h-12 rounded-full border border-gray-600 object-cover" alt="${safeAuthor[0]}">`
                : `<div class="w-12 h-12 rounded-full bg-gray-800 flex items-center justify-center font-bold text-xl text-cyan-500">${safeAuthor[0].toUpperCase()}</div>`;

            div.className = `glass-card p-6 md:p-8 rounded-2xl flex gap-4 md:gap-6 border ${borderClass}`;
            div.innerHTML = `
                <div class="flex-shrink-0 flex flex-col items-center gap-2">
                    <div class="cursor-pointer" onclick="viewUserProfile('${safeAuthor}')">${avatar}</div>
                    <div class="text-xs font-bold text-center mt-1 cursor-pointer hover:text-cyan-400" onclick="viewUserProfile('${safeAuthor}')">${safeAuthor}</div>
                    <div class="flex flex-col gap-1 items-center">${badges}</div>
                </div>
                <div class="flex-grow min-w-0">
                    <div class="flex justify-between items-start mb-4 pb-2 border-b border-white/5">
                        <span class="text-xs text-gray-500 font-mono">${formatGeorgianDate(post.time)}</span>
                        ${!isReply ? '<span class="px-2 py-0.5 bg-cyan-900/30 text-cyan-400 text-xs rounded border border-cyan-500/30">ავტორი</span>' : ''}
                    </div>
                    <div class="text-gray-200 leading-relaxed whitespace-pre-wrap break-words text-sm md:text-base">${escapeHtml(post.content)}</div>
                    <div class="mt-6 flex justify-end items-center gap-4 pt-4 border-t border-white/5">
                        <button onclick="toggleLike('${post.id}')" class="text-sm flex items-center gap-2 text-gray-400 hover:text-pink-500 transition group" title="Like">
                            <i class="fas fa-heart group-hover:scale-125 transition-transform ${post.likes?.includes(currentUser) ? 'text-pink-500' : ''}"></i> 
                            ${post.likes?.length || 0}
                        </button>
                        ${userData?.role === 'admin' ? `<button onclick="deletePost('${post.id}')" class="text-xs text-red-400 hover:underline" title="წაშლა">წაშლა</button>` : ''}
                    </div>
                </div>
            `;
            return div;
        }

        /* --- მოქმედებები / Actions --- */

        async function handleNewThread(e) {
            e.preventDefault();
            if (!currentUser) return showLogin();
            
            const title = document.getElementById('threadTitleInput').value.trim();
            const content = document.getElementById('threadContent').value.trim();
            const submitBtn = document.getElementById('submitThreadBtn');
            
            submitBtn.disabled = true;

            const res = await api(`/posts/${currentSection}`, { method: 'POST', body: JSON.stringify({title, content})});
            if(res && res.ok) {
                closeActiveModal();
                renderThreads();
                fetchPostCounts();
                showToast('თემა გამოქვეყნდა');
            }
            submitBtn.disabled = false;
        }

        document.getElementById('newReplyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return showLogin();

            const contentEl = document.getElementById('replyContent');
            const content = contentEl.value.trim();
            const submitBtn = document.getElementById('submitReplyBtn');

            if (!content) return showToast('ტექსტი ცარიელია.', 'error');

            submitBtn.disabled = true;

            const res = await api(`/posts/${currentSection}`, { method: 'POST', body: JSON.stringify({content, parentId: currentThread})});
            if(res && res.ok) {
                contentEl.value = '';
                renderThread();
                fetchPostCounts();
                showToast('პასუხი გაიგზავნა');
            }
            submitBtn.disabled = false;
        });

        async function toggleLike(id) {
            if(!currentUser) return showLogin();
            await api(`/posts/${currentSection}/${id}/like`, {method: 'POST'});
            if(currentThread) renderThread();
        }
        
        async function deletePost(id) {
            if(!confirm('დარწმუნებული ხართ? ოპერაცია უკანკელი არ იქნება.')) return;
            const res = await api(`/posts/${currentSection}/delete-post`, {method: 'POST', body: JSON.stringify({postId: id})});
            if(res && res.ok) {
                if(id === currentThread) {
                    backToSectionFromThread();
                } else {
                    renderThread();
                }
                fetchPostCounts();
                showToast('შეტყობინება წაშლილია');
            }
        }

        async function deleteThread(e, id) {
             e.stopPropagation(); 
            if(!confirm('დარწმუნებული ხართ რომ გსურთ თემის და ყველა პასუხის წაშლა?')) return;
            const res = await api(`/posts/${currentSection}/delete-thread`, {method: 'POST', body: JSON.stringify({threadId: id})});
            if(res && res.ok) {
                renderThreads();
                fetchPostCounts();
                showToast('თემა წაშლილია');
            }
        }

        async function togglePin(e, id) {
            e.stopPropagation(); 
            const res = await api(`/posts/${currentSection}/${id}/pin`, {method: 'POST'});
            if(res && res.ok) {
                renderThreads();
                showToast('სტატუსი განახლდა');
            }
        }

        /* --- ნავიგაცია / Navigation Logic --- */

        function openThread(id, title) {
            currentThread = id;
            document.getElementById('threadTitle').textContent = escapeHtml(title);
            updateBreadcrumbs('thread');
            switchView('threadView');
            renderThread();
            clearInterval(refreshInterval);
            refreshInterval = setInterval(renderThread, 15000); 
        }

        function backToForum() {
            switchView('forumView');
            currentSection = null;
            currentThread = null;
            clearInterval(refreshInterval);
            refreshInterval = null;
        }

        function backToForumFromSection() {
            backToForum();
        }

        function backToSectionFromThread() {
            switchView('sectionView');
            currentThread = null;
            renderThreads();
            clearInterval(refreshInterval);
            refreshInterval = setInterval(renderThreads, 30000); 
        }

        function updateBreadcrumbs(type) {
            const sectionName = document.getElementById('sectionTitle')?.textContent || currentSection;
            const crumbs = type === 'section' 
                ? `მთავარი > ${sectionName}` 
                : `მთავარი > ${sectionName} > თემა`;
            const el = type === 'section' ? 'sectionBreadcrumbs' : 'threadBreadcrumbs';
            document.getElementById(el).textContent = crumbs;
        }

        /* --- პროფილი / Profile --- */

        async function showProfile() {
            const res = await api('/me');
            if(res && res.ok) {
                const data = await res.json();
                currentUser = data.username;
                userData = data;
                renderProfileView(data, true);
            }
        }

        async function viewUserProfile(username) {
            if(username === currentUser) return showProfile();
            const res = await api(`/users/${username}`);
            if(res && res.ok) {
                const data = await res.json();
                renderProfileView(data, false);
            } else if (res && res.status === 404) {
                showToast('მომხმარებელი ვერ მოიძებნა.', 'error');
            }
        }

        function renderProfileView(data, isOwner) {
            switchView('profileView');
            
            const avatarUrl = data.profile.avatar ? escapeHtml(data.profile.avatar) : '';
            const avatarDiv = document.getElementById('profileAvatarLarge');
            
            avatarDiv.style.backgroundImage = avatarUrl ? `url(${avatarUrl})` : 'none';
            avatarDiv.style.backgroundSize = 'cover';
            avatarDiv.style.backgroundPosition = 'center';
            avatarDiv.textContent = avatarUrl ? '' : data.username[0].toUpperCase();
            
            document.getElementById('profileUsername').textContent = escapeHtml(data.username);
            document.getElementById('profileBadges').innerHTML = (data.badges || []).map(getBadgeHtml).join('');

            ['Name', 'Email', 'Phone', 'Bio'].forEach(f => {
                const key = f.toLowerCase();
                const displayValue = data.profile[key] ? escapeHtml(data.profile[key]) : '-';
                document.getElementById(`display${f}`).textContent = displayValue;
                
                if(isOwner) {
                    const editEl = document.getElementById(`edit${f}`);
                    if (editEl) editEl.value = data.profile[key] || '';
                }
            });
            
            const previewEl = document.getElementById('avatarPreview');
            previewEl.style.backgroundImage = avatarUrl ? `url(${avatarUrl})` : 'none';
            previewEl.style.backgroundSize = 'cover';
            
            const tabs = document.querySelectorAll('.tab-btn');
            switchTab('info', tabs[0]);

            tabs[1].style.display = isOwner ? 'block' : 'none';
            document.getElementById('adminTabBtn').style.display = (isOwner && data.role === 'admin') ? 'block' : 'none';
        }

        function switchTab(name, btn) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            const tabContent = document.getElementById(`${name}Tab`);
            if (tabContent) tabContent.classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('text-cyan-400', 'border-b-2', 'border-cyan-400', 'font-bold');
                b.classList.add('text-gray-400', 'hover:text-cyan-200');
            });
            btn.classList.remove('text-gray-400', 'hover:text-cyan-200');
            btn.classList.add('text-cyan-400', 'border-b-2', 'border-cyan-400', 'font-bold');
        }

        document.getElementById('profileEditForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveProfileBtn');
            const orig = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = 'შენახვა...';
            
            const formData = new FormData();
            const file = document.getElementById('editAvatar').files[0];
            if(file) formData.append('avatar', file);
            
            ['Name', 'Email', 'Phone', 'Bio'].forEach(f => {
                const value = document.getElementById(`edit${f}`).value || '';
                formData.append(f.toLowerCase(), value);
            });

            const res = await fetch(FORUM_API_BASE_URL + '/me', {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${localData.token}` },
                body: formData
            });

            if(res.ok) {
                showToast('პროფილი განახლებულია');
                await showProfile(); 
            } else {
                showToast('განახლება ვერ მოხერხდა.', 'error');
            }
            btn.disabled = false;
            btn.innerHTML = orig;
        });

        function previewAvatar(input) {
            const el = document.getElementById('avatarPreview');
            if(input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => {
                    el.style.backgroundImage = `url(${e.target.result})`;
                    el.style.backgroundSize = 'cover';
                    el.textContent = '';
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                el.style.backgroundImage = 'none';
                el.textContent = userData?.username[0].toUpperCase() || '';
            }
        }

        /* --- ადმინისტრაცია / Admin --- */
        async function assignBadge(e) {
            e.preventDefault();
            const u = document.getElementById('badgeUsername').value.trim();
            const b = document.getElementById('badgeName').value.trim().toUpperCase();
            
            if (!u || !b) return showToast('ველები სავალდებულოა.', 'error');
            
            const res = await api(`/admin/badge/${u}`, {method:'POST', body:JSON.stringify({badge:b})});
            if(res && res.ok) {
                showToast(`ბეჯი ${b} მიენიჭა ${u}-ს`);
                document.getElementById('badgeUsername').value = '';
                document.getElementById('badgeName').value = '';
            }
        }
        async function removeBadge(e) {
            e.preventDefault();
            const u = document.getElementById('removeBadgeUsername').value.trim();
            const b = document.getElementById('removeBadgeName').value.trim().toUpperCase();
            
            if (!u || !b) return showToast('ველები სავალდებულოა.', 'error');

            const res = await api(`/admin/badge/${u}`, {method:'DELETE', body:JSON.stringify({badge:b})});
            if(res && res.ok) {
                showToast(`ბეჯი ${b} წაიშალა ${u}-სგან`);
                document.getElementById('removeBadgeUsername').value = '';
                document.getElementById('removeBadgeName').value = '';
            }
        }

        /* --- EMAIL FORM LOGIC --- */
        
        // 1. Master function to open form modal based on section
        function openFormModalForCurrentSection() {
            if (!currentUser) return showLogin();
            
            const email = userData?.profile?.email;
            if (!email || !email.includes('@')) {
                return showToast('გთხოვთ, დაამატოთ ვალიდური ელფოსტა თქვენს პროფილში, რათა შეძლოთ მოთხოვნების გაგზავნა.', 'error');
            }

            const sectionsRequiringEmail = {
                'suggestions': { title: 'ახალი შემოთავაზება', formType: 'შემოთავაზება', fields: `
                    <input type="text" id="suggestionTitle" placeholder="სათაური" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required maxlength="100">
                    <textarea id="suggestionContent" rows="5" placeholder="შემოთავაზების დეტალური აღწერა" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required></textarea>
                `},
                'complaints-admin': { title: 'საჩივარი ადმინისტრატორზე', formType: 'საჩივარი ადმინზე', fields: `
                    <input type="text" id="adminUsername" placeholder="ადმინისტრატორის სახელი" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required maxlength="50">
                    <input type="text" id="complaintReason" placeholder="მოკლე აღწერა/სათაური" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required maxlength="100">
                    <textarea id="complaintDetails" rows="5" placeholder="დეტალურად აღწერეთ ინციდენტი, დრო და ადგილი" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required></textarea>
                    <input type="url" id="complaintEvidence" placeholder="დამამტკიცებელი მასალის ლინკი (YouTube/Imgur)" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none">
                `},
                'vacancies-leaders': { title: 'განაცხადი ლიდერობაზე', formType: 'ლიდერობის განაცხადი', fields: `
                    <input type="text" id="factionName" placeholder="სასურველი ფრაქცია/პოზიცია" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required maxlength="100">
                    <textarea id="motivationLetter" rows="5" placeholder="მოკლედ თქვენს გამოცდილებაზე და მოტივაციაზე" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required></textarea>
                `},
                'donation-help': { title: 'დახმარება დონაციაზე', formType: 'დახმარება დონაციაზე', fields: `
                    <input type="text" id="paymentMethod" placeholder="გადახდის მეთოდი (მაგ: ბარათი, PayBox)" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required maxlength="50">
                    <input type="text" id="transactionId" placeholder="ტრანზაქციის ID (თუ გაქვთ)" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none">
                    <textarea id="issueDescription" rows="5" placeholder="დეტალურად აღწერეთ პრობლემა (მაგ: თანხა ჩამოიჭრა და არაფერი არ დაერიცხა)" class="w-full p-3 bg-gray-900/50 rounded-lg border border-cyan-500/30 focus:border-cyan-400 outline-none" required></textarea>
                `}
            };

            const formInfo = sectionsRequiringEmail[currentSection];

            // If it's a regular thread section, show the thread modal instead
            if (!formInfo) {
                return showNewThreadModal();
            }

            // Otherwise, show the email form modal
            openModal(`
                <h2 class="text-2xl font-bold gradient-text mb-4">${formInfo.title}</h2>
                <p class="text-sm text-gray-400 mb-4">დადასტურება გამოგეგზავნებათ თქვენს ელფოსტაზე: <strong>${escapeHtml(email)}</strong></p>
                <form onsubmit="handleEmailFormSubmit(event, '${formInfo.formType}')" class="space-y-4">
                    ${formInfo.fields}
                    <div class="flex justify-end gap-3">
                        <button type="button" onclick="closeActiveModal()" class="text-gray-400 hover:text-white px-4">გაუქმება</button>
                        <button type="submit" id="submitEmailFormBtn" class="btn-gradient px-6 py-2 rounded-lg"><span class="relative z-10"><i class="fas fa-paper-plane"></i> გაგზავნა</span></button>
                    </div>
                </form>
            `);
        }
        
        // 2. Main handler for email form submissions (POST to /submit-form)
        async function handleEmailFormSubmit(event, formType) {
            event.preventDefault();
            
            // Re-check auth and email for safety
            if (!currentUser) return showLogin();
            
            const userEmail = userData?.profile?.email;
            if (!userEmail || !userEmail.includes('@')) {
                return showToast('გთხოვთ დაამატოთ ელფოსტა თქვენს პროფილში', 'error');
            }
            
            let formData = {};
            const form = event.target;
            
            // Logic to collect dynamic form data based on formType
            if (formType === 'შემოთავაზება') {
                formData = {
                    'შემოთავაზების სათაური': form.querySelector('#suggestionTitle').value,
                    'დეტალები': form.querySelector('#suggestionContent').value
                };
            } else if (formType === 'საჩივარი ადმინზე') {
                formData = {
                    'ადმინისტრატორის სახელი': form.querySelector('#adminUsername').value,
                    'სათაური': form.querySelector('#complaintReason').value,
                    'დეტალები': form.querySelector('#complaintDetails').value,
                    'დამამტკიცებელი მასალა': form.querySelector('#complaintEvidence').value || 'არ არის'
                };
            } else if (formType === 'ლიდერობის განაცხადი') {
                formData = {
                    'სასურველი ფრაქცია': form.querySelector('#factionName').value,
                    'მოტივაცია/გამოცდილება': form.querySelector('#motivationLetter').value
                };
            } else if (formType === 'დახმარება დონაციაზე') {
                formData = {
                    'გადახდის მეთოდი': form.querySelector('#paymentMethod').value,
                    'ტრანზაქციის ID': form.querySelector('#transactionId').value || 'არ არის',
                    'პრობლემის აღწერა': form.querySelector('#issueDescription').value
                };
            } else {
                 return showToast('ფორმის ტიპი არასწორია', 'error');
            }

            const submitBtn = document.getElementById('submitEmailFormBtn');
            submitBtn.disabled = true;

            showLoading(true);
            
            const response = await fetch(FORUM_API_BASE_URL + '/submit-form', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localData.token}`
                },
                body: JSON.stringify({
                    formType: formType,
                    formData: formData,
                    userInfo: {
                        username: currentUser,
                        email: userEmail
                    }
                })
            });
            
            showLoading(false);
            submitBtn.disabled = false;
            
            if (response.ok) {
                const result = await response.json();
                showToast(result.message || 'მოთხოვნა წარმატებით გაიგზავნა!');
                closeActiveModal();
                // Optional: Clear form fields
                form.reset();
            } else {
                const error = await response.json();
                showToast(error.message || 'შეცდომა გაგზავნისას', 'error');
            }
        }
        
        // 3. Adjust the existing 'createThreadBtn' logic on the section view
        // The HTML element's onClick is now 'openFormModalForCurrentSection()'

        /* --- ინიციალიზაცია / Init --- */
        document.addEventListener('DOMContentLoaded', async () => {
            document.querySelectorAll('.section-link').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!currentUser) return showLogin();
                    
                    currentSection = el.dataset.section;
                    // Extract name specifically avoiding English fallback in UI
                    const name = el.querySelector('span.text-sm').textContent.trim();
                    document.getElementById('sectionTitle').textContent = name;
                    updateBreadcrumbs('section');
                    switchView('sectionView');
                    renderThreads();
                    
                    const btn = document.getElementById('createThreadBtn');
                    const viewOnly = el.dataset.viewOnly === 'true';
                    
                    // Sections that use the email form instead of regular threads
                    const emailFormSections = ['suggestions', 'complaints-admin', 'vacancies-leaders', 'donation-help'];

                    // If it's an email form section, update the button text and check only for email/login
                    if(emailFormSections.includes(currentSection)) {
                        btn.innerHTML = '<span class="relative z-10"><i class="fas fa-paper-plane"></i> გაგზავნა</span>';
                        btn.onclick = openFormModalForCurrentSection; // Set to the new email form function
                        btn.style.display = 'flex'; // Always show form button if logged in
                    }
                    // If it's a regular thread section
                    else {
                        btn.innerHTML = '<span class="relative z-10"><i class="fas fa-plus"></i> ახალი თემა</span>';
                        btn.onclick = showNewThreadModal; // Set back to original thread function
                        btn.style.display = (viewOnly && userData?.role !== 'admin') ? 'none' : 'flex';
                    }

                    clearInterval(refreshInterval);
                    refreshInterval = setInterval(renderThreads, 30000);
                });
            });

            if(localData.token) {
                await api('/me').then(async res => {
                    if(res && res.ok) {
                        const data = await res.json();
                        currentUser = data.username;
                        userData = data;
                        updateUI();
                        fetchPostCounts();
                    } else {
                        logout();
                    }
                });
            } else {
                showWelcomeModal();
            }
        });
    </script>
</body>
</html>
