<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaratic Role Play - ფორუმი | ოფიციალური პორტალი</title>
   
    <link rel="icon" href="https://raw.githubusercontent.com/OGSunny/Testerweb/main/zaratic.png" type="image/png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap">
    <style>
        /* CORE RESET AND VARIABLES - SHARP MODERN CYBER PALETTE */
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            /* Base Colors */
            --primary:#00ffff;          /* Electric Cyan/Aqua */
            --primary-dark:#00b3b3;     
            --secondary:#0a1e30;        /* Very Dark Slate Blue */
            
            /* Dark/Serious Background */
            --dark:#070d14;             /* Near Black/Deepest Navy */
            --dark-light:#0e1722;       /* Section Background (Slightly Lighter) */
            --dark-lighter:rgba(14, 23, 34, 0.7); /* **GLASSMORHPISM BASE** */
            --modal-bg:rgba(7, 13, 20, 0.95); /* Deeper Modal Background */
            
            /* Text & Accent */
            --text:#ffffff;             /* Pure White for body */
            --text-muted:#7e90a0;       /* Cool Gray for secondary info */
            
            /* Gradients */
            --gradient-primary:linear-gradient(135deg, #00ffff, #0066ff);
            --gradient-border:linear-gradient(135deg, #00ffff, #0066ff, #00ffff);
            
            /* Structure & Shadows - MODERN LAYERED SHADOWS */
            --shadow-md:0 4px 12px rgba(0,0,0,0.4), 0 0 10px rgba(0, 255, 255, 0.1);
            --shadow-lg:0 8px 32px rgba(0, 0, 0, 0.6), 0 0 20px rgba(0, 255, 255, 0.2);
            --shadow-hover:0 12px 48px rgba(0, 0, 0, 0.8), 0 0 40px rgba(0, 255, 255, 0.4);
            --border-color:rgba(0,255,255,0.2); /* Subtle Cyan Border for glass */
            --input-shadow:inset 0 0 8px rgba(0,0,0,0.6); /* Inset for input depth */

            /* Animations */
            --transition-speed:0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast:0.3s ease;

            /* Badge Colors (Vibrant/Animated) */
            --badge-admin:linear-gradient(135deg, #00ffff, #0066ff);
            --badge-vip:linear-gradient(135deg, #ffc300, #ff7e00);
            --badge-mod:linear-gradient(135deg, #9966ff, #6633cc);
            --badge-helper:linear-gradient(135deg, #39ff14, #1c8a16);
            --badge-text: #000000;
        }
        
        /* GENERAL STYLING */
        html{scroll-behavior:smooth}
        body{
            font-family:'Poppins',sans-serif;
            background:var(--dark);
            color:var(--text);min-height:100vh;overflow-x:hidden;position:relative;
            line-height:1.7; /* Enhanced readability */
            /* Animated Gradient Mesh Background (Particle Effect 6) */
            background-image:linear-gradient(135deg, #070d14, #101e30, #070d14);
            background-size:400% 400%;
            animation:gradientShift 20s ease infinite;
        }
        body::before{
            content:'';position:fixed;top:0;left:0;width:100%;height:100%;
            /* Subtle floating particles in background (Particle Effect 1) */
            background:radial-gradient(circle at 10% 20%, rgba(0,255,255,0.05) 0%, transparent 10%),
                       radial-gradient(circle at 90% 80%, rgba(0,102,255,0.05) 0%, transparent 10%);
            pointer-events:none;z-index:-1;
        }
        
        /* ANIMATIONS */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px currentColor; }
            50% { box-shadow: 0 0 20px currentColor; }
        }
        
        /* Navbar - Glassmorphism & Sticky Blur */
        .navbar{
            background:rgba(14, 23, 34, 0.6); /* Semi-transparent */
            backdrop-filter: blur(10px); /* Glassmorphism */
            border-bottom:1px solid var(--border-color);
            padding:1rem 0;position:sticky;top:0;z-index:1000;box-shadow:var(--shadow-lg);
            transition:var(--transition-fast); /* Smooth scroll-triggered blur increase */
        }
        /* Sticky blur increase (Simulated: Add JS to change class on scroll) */
        .navbar.scrolled{backdrop-filter: blur(20px);box-shadow:0 0 30px rgba(0,255,255,0.3);}

        .logo{
            font-size:1.6rem;font-weight:800;color:var(--primary);
            text-shadow:0 0 10px var(--primary), 0 0 20px rgba(0,255,255,0.5); /* Neon glow to logo */
        }
        .logo img{
            height:40px;border-radius:2px;
            border:2px solid var(--primary);
            transition:var(--transition-fast);
        }
        .logo img:hover{
            transform: scale(1.1) rotate(5deg);
            box-shadow:0 0 15px var(--primary);
        }

        .user-info{
            background:var(--dark-lighter);
            border:1px solid var(--border-color);
            transition:var(--transition-fast);
        }
        .user-info:hover{
            background:rgba(14, 23, 34, 0.9);
            border-color:var(--primary);
            transform:translateY(-3px); /* Card hover animation */
            box-shadow:0 0 15px rgba(0,255,255,0.3);
        }
        .user-avatar{
            transition:var(--transition-fast);
            box-shadow:0 0 8px rgba(0,255,255,0.7);
        }
        .user-avatar:hover{
            transform:scale(1.1); /* Smooth avatar hover */
            animation:glow 1.5s infinite alternate; /* Floating/Glow on hover */
        }

        /* BADGES - ANIMATED GLOW & SHIMMER */
        .badge{
            padding:0.3rem 0.7rem;border-radius:4px; /* Slightly softer corners */
            border:1px solid rgba(255,255,255,0.4);
            color:var(--badge-text);
            box-shadow:var(--shadow-sm);
            transition:all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            background-size:200% auto;
            animation:scale-in 0.5s ease-out; /* Animate badge appearance */
            position:relative;
            overflow:hidden;
        }
        .badge:hover{
            transform:scale(1.1);
            box-shadow:0 0 15px currentColor;
            animation:glow 1.5s infinite alternate, shimmer 2s infinite linear; /* Glow and Shimmer on hover */
            cursor:help;
        }
        .badge[data-name="ADMIN"]{background:var(--badge-admin);color:#000;}
        .badge[data-name="VIP"]{background:var(--badge-vip);color:#000;}
        .badge[data-name="MODERATOR"]{background:var(--badge-mod);color:#fff;}
        .badge[data-name="HELPER"]{background:var(--badge-helper);color:#000;}

        @keyframes scale-in {from{opacity:0;transform:scale(0.8)} to{opacity:1;transform:scale(1)}}

        .container{
            max-width:1400px;margin:2.5rem auto;padding:0 1.5rem;
            /* Fade-in-up for main content */
            animation:fadeInUp 1s ease-out; 
        }
        
        /* CATEGORIES - GLASSMORHPISM CARD */
        .cat{
            backdrop-filter: blur(15px) saturate(180%);
            background: rgba(14, 23, 34, 0.7); /* Glassmorphism Background */
            border: 1px solid var(--border-color);
            border-left:5px solid var(--primary);
            box-shadow: var(--shadow-md);
            transition:var(--transition-speed);
            position:relative;
            overflow:hidden;
        }
        .cat:hover{
            transform:translateY(-5px); /* Card hover animation */
            box-shadow:var(--shadow-hover);
            border-color:rgba(0,255,255,0.6);
        }
        .cat-header{
            background:rgba(10, 30, 48, 0.8);
            border-bottom:1px solid var(--border-color);
            color:var(--primary);
        }
        .section{
            transition:var(--transition-fast);
        }
        .section:hover{
            background:rgba(21, 35, 51, 0.8); /* Darker hover */
            border-left-color:var(--primary);
        }
        
        /* THREADS & POSTS - GLASSMORHPISM CARD */
        .thread-card,.post{
            backdrop-filter: blur(10px) saturate(150%);
            background: var(--dark-lighter); /* Glassmorphism Background */
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition:var(--transition-speed);
            position:relative;
            overflow:hidden;
        }
        .thread-card:hover{
            transform:translateY(-8px) scale(1.01); /* Enhanced card hover animation */
            box-shadow:var(--shadow-hover);
            border-color:rgba(0,255,255,0.6);
        }
        .thread-card h3{
            color:var(--primary);
            text-shadow:0 0 5px rgba(0,255,255,0.3); /* Subtle neon glow on thread titles */
        }
        .pinned{
            border:2px solid var(--accent-green);
            box-shadow:0 0 10px rgba(57,255,20,0.5), 0 0 25px rgba(57,255,20,0.3); /* Enhanced pinned glow */
            position:relative;
        }
        .pinned::before {
            content: 'PINNED';
            position: absolute;
            top: 0;
            right: 0;
            padding: 5px 10px;
            background: var(--accent-green);
            color: var(--dark);
            font-size: 0.7rem;
            font-weight: 700;
            clip-path: polygon(100% 0, 100% 100%, 0 0);
        }
        .new-indicator{
            animation:pulse 1.5s infinite; /* Pulse animation for new indicator */
            background:var(--accent-orange);
            color:var(--dark);
        }

        /* FORMS - INSET SHADOWS & GRADIENT BORDERS */
        textarea,input[type="text"],input[type="email"],input[type="password"],input[type="tel"]{
            background:rgba(0,0,0,0.5);
            border:1px solid var(--border-color);
            box-shadow:var(--input-shadow); /* Inset shadow */
            transition:var(--transition-fast);
        }
        textarea:focus,input:focus{
            border:1px solid;
            border-image:var(--gradient-primary) 1; /* Animated border on focus */
            box-shadow:0 0 15px rgba(0,255,255,0.8); /* Focus glow */
            outline:none;background:rgba(0,0,0,0.7);
        }
        
        /* BUTTONS - GRADIENTS, SHIMMER & RIPPLE EFFECT */
        .btn{
            border-radius:4px;
            transition:var(--transition-fast);
            position:relative;overflow:hidden;
            z-index:1;
        }
        .btn-primary{
            background:var(--gradient-primary); /* Vibrant Gradient */
            background-size:200% 200%;
            animation:gradientShift 3s ease infinite; /* Animated Gradient background */
            color:var(--dark);
            box-shadow:0 0 10px rgba(0,255,255,0.4);
        }
        .btn-primary:hover{
            transform:scale(1.05); /* Button hover transform */
            box-shadow:0 0 20px rgba(0,255,255,0.7);
            background-position:100% 50%;
        }
        .btn-secondary{
            background:var(--dark-lighter);
            border:1px solid var(--primary);
            color:var(--primary);
        }
        .btn-secondary:hover{
            transform:scale(1.05);
            background:rgba(14, 23, 34, 0.9);
            box-shadow:0 0 10px rgba(0,255,255,0.4);
        }

        /* Ripple Effect (Micro-interaction 1) - CSS Simulation */
        .btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0);
            transition: all 0.5s ease-out;
            pointer-events: none;
            z-index: 2;
        }
        .btn:active::after {
            transform: translate(-50%, -50%) scale(15);
            opacity: 1;
            transition: all 0.3s ease-in;
        }

        /* MODALS - GLASSMORHPISM & ENTRANCE ANIMATION */
        .modal,.fullscreen-modal{
            background:var(--modal-bg); /* Deeper black overlay */
            transition:opacity 0.5s ease;
        }
        .modal-content{
            backdrop-filter: blur(20px) saturate(180%) brightness(0.8); /* Deeper Blur */
            background: rgba(14, 23, 34, 0.8);
            border:2px solid var(--primary);
            box-shadow:0 0 40px rgba(0,255,255,0.6); /* Stronger glow */
            transform:scale(0.95);
            opacity:0;
            transition:all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); /* Animate modal entrance */
        }
        .modal.active .modal-content,.fullscreen-modal.active .modal-carousel{
            transform:scale(1);
            opacity:1;
        }
        .modal-header h2{
            color:transparent; /* For Gradient Text */
            background:var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            text-shadow:0 0 5px rgba(0,255,255,0.8); /* Neon glow on modal title */
        }
        
        /* CAROUSEL - GLASSMORHPISM */
        .modal-carousel{
            backdrop-filter: blur(20px) saturate(180%) brightness(0.8);
            background: rgba(14, 23, 34, 0.7);
            border:2px solid var(--primary);
            box-shadow:0 0 40px rgba(0,255,255,0.5);
            transform:scale(0.95);
            opacity:0;
            transition:all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .carousel-title{
            color:transparent; /* Gradient Text */
            background:var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            text-shadow:0 0 5px var(--primary);
        }
        .carousel-nav:hover{
            transform:scale(1.1);
        }
        
        /* PROFILE - GLASSMORHPISM */
        .profile-section{
            backdrop-filter: blur(10px) saturate(150%);
            background: var(--dark-lighter);
            border:1px solid var(--border-color);
            box-shadow:var(--shadow-md);
            border-left:5px solid var(--primary);
            transition:var(--transition-fast);
        }
        .profile-avatar-large{
            transition:var(--transition-fast);
            box-shadow:0 0 15px rgba(0,255,255,0.7);
            border:3px solid var(--primary);
            animation:floating 4s infinite ease-in-out; /* Floating animation for avatar */
        }
        @keyframes floating {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(1deg); }
        }
        .tabs{border-bottom:1px solid var(--border-color);}
        .tab{transition:var(--transition-fast);position:relative;}
        .tab.active{
            color:var(--primary);border-bottom-color:var(--primary);
            background:rgba(21, 35, 51, 0.8);
        }
        .tab-content{
            transition:opacity 0.5s, transform 0.5s;
            opacity:0;
            transform:translateY(10px);
            display:none; /* Ensure correct display management */
        }
        .tab-content.active{
            opacity:1;
            transform:translateY(0);
            display:block;
        }

        /* Info items (Micro-interaction) */
        .info-item{
            background:rgba(0, 0, 0, 0.4);
            border:1px solid var(--border-color);
            transition:var(--transition-fast);
        }
        .info-item:hover{
            border-color:var(--primary);
            transform:translateX(5px);
            box-shadow:0 0 10px rgba(0,255,255,0.2);
        }
        
        /* LOADING STATES (Skeleton Screens & Spinner) */
        .skeleton-loader {
            background: linear-gradient(90deg, #1f2a37 25%, #293847 50%, #1f2a37 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear; /* Shimmer effect for skeleton */
            border-radius: 4px;
            height: 1.2em;
            margin-bottom: 0.5rem;
            opacity: 0.7;
        }
        #loading{
            background:var(--gradient-primary);
            background-size:200% 200%;
            animation:gradientShift 2s ease infinite; /* Gradient spinner/loading */
        }

        /* Additional scroll/view transition classes */
        .view-transition-exit {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease-out;
        }
        .view-transition-enter {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.7s ease-out 0.2s forwards;
        }

        @media (max-width:768px){
            .navbar{backdrop-filter: blur(15px);}
        }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body>
    <nav class="navbar" id="mainNavbar">
        <div class="nav-content">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/OGSunny/Testerweb/main/zaratic.png" alt="Logo">
                <span><i class="fas fa-terminal"></i> ZARATIC PORTAL</span>
            </div>
            <div class="nav-actions" id="navActions">
                <button class="btn btn-primary" onclick="showWelcomeModal()">შესვლა</button>
                <button class="btn btn-secondary" onclick="showWelcomeModal()">რეგისტრაცია</button>
            </div>
        </div>
    </nav>

    <div class="container view-transition-enter" id="mainContainer">
        <div id="forumView">
            <div class="categories">
                <div class="cat">
                    <div class="cat-header"><i class="fas fa-server"></i> სერვერის ოპერაციები</div>
                    <a href="#" class="section" data-section="rules" data-view-only="true">
                        <div class="sec-info">
                            <i class="fas fa-book-open"></i>
                            <div class="sec-title">ოფიციალური წესდება (Ruleset)</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="news" data-view-only="true">
                        <div class="sec-info">
                            <i class="fas fa-broadcast-tower"></i>
                            <div class="sec-title">სისტემური განცხადებები</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="updates" data-view-only="true">
                        <div class="sec-info">
                            <i class="fas fa-code-branch"></i>
                            <div class="sec-title">ჩეინჯლოგი & განახლებები</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                </div>
                <div class="cat">
                    <div class="cat-header"><i class="fas fa-users-cog"></i> საზოგადოებრივი ინტერაქცია</div>
                    <a href="#" class="section" data-section="suggestions">
                        <div class="sec-info">
                            <i class="fas fa-hand-pointer"></i>
                            <div class="sec-title">სისტემის გაუმჯობესების წინადადებები</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="events">
                        <div class="sec-info">
                            <i class="fas fa-calendar-check"></i>
                            <div class="sec-title">ოფიციალური ივენთები და აქტივობები</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="biographies">
                        <div class="sec-info">
                            <i class="fas fa-id-card"></i>
                            <div class="sec-title">პერსონაჟების მონაცემები (Biography)</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                </div>
                <div class="cat">
                    <div class="cat-header"><i class="fas fa-exclamation-triangle"></i> ინციდენტების მართვა</div>
                    <a href="#" class="section" data-section="complaints-admin">
                        <div class="sec-info">
                            <i class="fas fa-user-lock"></i>
                            <div class="sec-title">ადმინისტრაციის ქმედების გასაჩივრება</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="complaints-player">
                        <div class="sec-info">
                            <i class="fas fa-user-times"></i>
                            <div class="sec-title">მოთამაშის წესების დარღვევა</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="appeals">
                        <div class="sec-info">
                            <i class="fas fa-balance-scale"></i>
                            <div class="sec-title">ბანის გასაჩივრება (Appeals)</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="unban">
                        <div class="sec-info">
                            <i class="fas fa-key"></i>
                            <div class="sec-title">განბლოკვის მოთხოვნა</div>
                        </div>
                        <div class="sec-stats">0</div> 
                </a>
                </div>
                <div class="cat">
                    <div class="cat-header"><i class="fas fa-briefcase"></i> კადრების დაქირავება</div>
                    <a href="#" class="section" data-section="vacancies-leaders">
                        <div class="sec-info">
                            <i class="fas fa-chess-king"></i>
                            <div class="sec-title">ლიდერის პოზიციაზე განაცხადი</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="vacancies-admin">
                        <div class="sec-info">
                            <i class="fas fa-shield-alt"></i>
                            <div class="sec-title">ადმინისტრატორის პოზიციაზე განაცხადი</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="vacancies-partner">
                        <div class="sec-info">
                            <i class="fas fa-link"></i>
                            <div class="sec-title">პარტნიორობის მოთხოვნა (Affiliation)</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                </div>
                <div class="cat">
                    <div class="cat-header"><i class="fas fa-cogs"></i> ტექნიკური დახმარება</div>
                    <a href="#" class="section" data-section="donation-help">
                        <div class="sec-info">
                            <i class="fas fa-hand-holding-usd"></i>
                            <div class="sec-title">ფინანსური ტრანზაქციების დახმარება</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="tech-help">
                        <div class="sec-info">
                            <i class="fas fa-bug"></i>
                            <div class="sec-title">ტექნიკური პრობლემების & ბაგების რეპორტი</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                    <a href="#" class="section" data-section="general">
                        <div class="sec-info">
                            <i class="fas fa-comments"></i>
                            <div class="sec-title">ზოგადი დისკუსიები</div>
                        </div>
                        <div class="sec-stats">0</div>
                    </a>
                </div>
            </div>
        </div>

        <div id="sectionView" class="view-transition-exit" style="display:none">
            <div class="breadcrumbs" id="sectionBreadcrumbs" style="color:var(--text-muted); margin-bottom:1rem;"></div>
            <button class="btn btn-secondary" onclick="backToForumFromSection()"><i class="fas fa-arrow-left"></i> უკან</button>
            <h2 id="sectionTitle" style="margin:1rem 0; color:var(--primary);"></h2>
            <button class="btn btn-primary" onclick="showNewThreadModal()">ახალი თრედი</button>
            <div class="threads-container" id="threadsList">
                </div>
        </div>

        <div id="threadView" class="view-transition-exit" style="display:none">
            <div class="breadcrumbs" id="threadBreadcrumbs" style="color:var(--text-muted); margin-bottom:1rem;"></div>
            <button class="btn btn-secondary" onclick="backToSectionFromThread()"><i class="fas fa-arrow-left"></i> უკან</button>
            <h2 id="threadTitle" style="margin:1rem 0; color:var(--primary);"></h2>
            <div class="posts-container" id="threadPosts"></div>
            <form id="newReplyForm" style="margin-top:2rem;">
                <div class="form-group">
                    <textarea id="replyContent" placeholder="დაწერეთ თქვენი პასუხი..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary">პასუხის გაგზავნა</button>
            </form>
        </div>

        <div id="profileView" class="view-transition-exit" style="display:none">
            <div class="profile-section">
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profileAvatarLarge"></div>
                    <div class="profile-details">
                        <h2 id="profileUsername">Username</h2>
                        <div class="user-badges" id="profileBadges"></div>
                    </div>
                </div>
                <div class="tabs">
                    <div class="tab active" onclick="switchTab(event, 'info')">ინფორმაცია</div>
                    <div class="tab" onclick="switchTab(event, 'edit')">რედაქტირება</div>
                    <div class="tab" onclick="switchTab(event, 'admin')" id="adminTab" style="display:none">ადმინ პანელი</div>
                </div>
                <div id="infoTab" class="tab-content active">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">სახელი</div>
                            <div class="info-value" id="displayName">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ელ. ფოსტა</div>
                            <div class="info-value" id="displayEmail">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ტელეფონი</div>
                            <div class="info-value" id="displayPhone">-</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ბიო</div>
                            <div class="info-value" id="displayBio">-</div>
                        </div>
                    </div>
                </div>
                <div id="editTab" class="tab-content">
                    <form id="profileEditForm">
                        <div class="form-group">
                            <label>ავატარი</label>
                            <div style="display:flex;align-items:center;gap:1rem">
                                <div id="avatarPreview" class="user-avatar" style="width:60px;height:60px"></div>
                                <input type="file" id="editAvatar" accept="image/*" onchange="previewAvatar(this)">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>სახელი</label>
                            <input type="text" id="editName" placeholder="თქვენი სახელი">
                        </div>
                        <div class="form-group">
                            <label>ელ. ფოსტა</label>
                            <input type="email" id="editEmail" placeholder="email@example.com">
                        </div>
                        <div class="form-group">
                            <label>ტელეფონი</label>
                            <input type="tel" id="editPhone" placeholder="+995 XXX XXX XXX">
                        </div>
                        <div class="form-group">
                            <label>ბიო</label>
                            <input type="text" id="editBio" placeholder="რამე თქვენს შესახებ...">
                        </div>
                        <button type="submit" class="btn btn-primary" id="saveProfileBtn">შენახვა</button>
                    </form>
                </div>
                <div id="adminTabContent" class="tab-content">
                    <h3 style="margin-bottom:1rem; color:var(--primary)">ბეჯების მართვა</h3>
                    <div style="background:var(--dark-lighter);padding:1.5rem;border-radius:4px;margin-bottom:1.5rem;border:1px solid var(--border-color); backdrop-filter: blur(10px);">
                        <h4 style="margin-bottom:1rem;color:var(--primary)">ბეჯის დამატება</h4>
                        <div class="form-group">
                            <label>მომხმარებელი</label>
                            <input type="text" id="badgeUsername" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <label>ბეჯის სახელი</label>
                            <input type="text" id="badgeName" placeholder="მაგ: VIP">
                        </div>
                        <button class="btn btn-primary" onclick="assignBadge()">დამატება</button>
                    </div>
                    <div style="background:var(--dark-lighter);padding:1.5rem;border-radius:4px;border:1px solid var(--border-color); backdrop-filter: blur(10px);">
                        <h4 style="margin-bottom:1rem;color:var(--accent-orange)">ბეჯის წაშლა</h4>
                        <div class="form-group">
                            <label>მომხმარებელი</label>
                            <input type="text" id="removeBadgeUsername" placeholder="Username">
                        </div>
                        <div class="form-group">
                            <label>ბეჯი</label>
                            <input type="text" id="removeBadgeName" placeholder="ბეჯის სახელი">
                        </div>
                        <button class="btn btn-secondary" style="background:linear-gradient(135deg, var(--accent-orange), #b34d00); color:var(--dark);" onclick="removeBadge()">წაშლა</button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="backToForum()" style="margin-top:2rem">
                    <i class="fas fa-arrow-left"></i> უკან ფორუმზე
                </button>
            </div>
        </div>
    </div>

    <div id="welcomeModal" class="fullscreen-modal">
        <div class="modal-carousel">
            <button class="carousel-nav prev" onclick="prevSlide()"><i class="fas fa-chevron-left"></i></button>
            <button class="carousel-nav next" onclick="nextSlide()"><i class="fas fa-chevron-right"></i></button>
            <div class="carousel-slide active">
                <h2 class="carousel-title">ZARATIC RP ოფიციალური პორტალი</h2>
                <p class="carousel-description">თქვენ ეწვიეთ Zaratic Role Play-ს ფორუმს, როგორც სტუმარი. იმისთვის რომ გაეცნოთ ყველა საკითხს სრულად, გთხოვთ გაიაროთ რეგისტრაცია ან ავტორიზაცია.</p>
            </div>
            <div class="carousel-slide">
                <h2 class="carousel-title">სისტემური წვდომა</h2>
                <p class="carousel-description">შემოგვიერთდით და მიიღეთ სრული წვდომა სისტემურ ინფორმაციაზე, მიმდინარე ინციდენტების მართვასა და ოფიციალურ განაცხადებზე.</p>
            </div>
            <div class="carousel-actions">
                <button class="btn btn-primary" onclick="showRegister()"><i class="fas fa-user-plus"></i> რეგისტრაცია</button>
                <button class="btn btn-secondary" onclick="showLogin()"><i class="fas fa-sign-in-alt"></i> ავტორიზაცია</button>
            </div>
            <div class="carousel-dots" style="margin-top:2rem;">
                <div class="carousel-dot active" onclick="showSlide(0)" style="background:var(--primary)"></div>
                <div class="carousel-dot" onclick="showSlide(1)" style="background:var(--text-muted)"></div>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content">
            <div class="modal-header"><h2>შესვლა</h2></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>მომხმარებელი</label>
                    <input type="text" id="loginUsername" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <label>პაროლი</label>
                    <input type="password" id="loginPassword" placeholder="Password" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">შესვლა</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('loginModal')">გაუქმება</button>
                </div>
            </form>
        </div>
    </div>

    <div id="registerModal" class="modal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content">
            <div class="modal-header"><h2>რეგისტრაცია</h2></div>
            <form id="registerForm">
                <div class="form-group">
                    <label>მომხმარებელი</label>
                    <input type="text" id="regUsername" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <label>ელ. ფოსტა</label>
                    <input type="email" id="regEmail" placeholder="email@example.com" required>
                </div>
                <div class="form-group">
                    <label>პაროლი (მინ. 8 სიმბოლო)</label>
                    <input type="password" id="regPassword" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">რეგისტრაცია</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('registerModal')">გაუქმება</button>
                </div>
            </form>
        </div>
    </div>

    <div id="verifyModal" class="modal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content">
            <div class="modal-header"><h2>ელფოსტის ვერიფიკაცია</h2></div>
            <form id="verifyForm">
                <div class="form-group">
                    <label>ვერიფიკაციის კოდი (8 ციფრი)</label>
                    <input type="text" id="verifyCode" placeholder="12345678" maxlength="8" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">დადასტურება</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('verifyModal')">გაუქმება</button>
                </div>
            </form>
        </div>
    </div>

    <div id="newThreadModal" class="modal" onclick="closeModalOnBackdrop(event)">
        <div class="modal-content">
            <div class="modal-header"><h2>ახალი თრედი</h2></div>
            <form id="newThreadForm">
                <div class="form-group">
                    <label>სათაური</label>
                    <input type="text" id="threadTitleInput" placeholder="თრედის სათაური" required>
                </div>
                <div class="form-group">
                    <label>შინაარსი</label>
                    <textarea id="threadContent" placeholder="დაწერეთ თქვენი პოსტი..." rows="6" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">შექმნა</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('newThreadModal')">გაუქმება</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading" style="position:fixed;bottom:20px;right:20px;background:var(--primary);color:var(--dark);padding:10px 20px;border-radius:4px;font-weight:700;box-shadow:var(--shadow-md);z-index:3000;display:none;">იტვირთება...</div>
    <div id="toast" style="position:fixed;top:20px;right:20px;padding:10px 20px;border-radius:4px;color:var(--dark);font-weight:700;box-shadow:var(--shadow-md);z-index:3000;display:none;"></div>

    <script>
        const API_URL = 'https://data7167.jemalagegidze.workers.dev';
        emailjs.init('6mfdsM4fGZ9WWDFst');

        let currentUser = null;
        let userData = null;
        let currentSection = null;
        let currentThread = null;
        let sectionPosts = [];
        let refreshInterval = null;
        const storageKey = 'zaraticForum_v2';
        let localData = JSON.parse(localStorage.getItem(storageKey)) || { token: null };

        // --- ENHANCED TRANSITION LOGIC ---
        function applyViewTransition(fromId, toId, animate = true) {
            const fromEl = document.getElementById(fromId);
            const toEl = document.getElementById(toId);

            if (animate) {
                fromEl.classList.remove('view-transition-enter');
                fromEl.classList.add('view-transition-exit');
                
                setTimeout(() => {
                    fromEl.style.display = 'none';
                    fromEl.classList.remove('view-transition-exit');
                    
                    toEl.style.display = 'block';
                    toEl.classList.add('view-transition-enter');
                }, 400); // Wait for exit transition (0.4s)
            } else {
                fromEl.style.display = 'none';
                toEl.style.display = 'block';
            }
        }

        async function api(path, options = {}) {
            showLoading(true);
            // console.log(`API REQUEST → ${options.method || 'GET'} ${API_URL}${path}`);
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (localData.token) headers['Authorization'] = `Bearer ${localData.token}`;

            let res;
            try {
                res = await fetch(API_URL + path, { ...options, headers });
                // console.log(`API RESPONSE ← ${res.status} ${path}`);
            } catch (err) {
                console.error('ქსელის ან CORS შეცდომა:', err);
                showToast('ინტერნეტთან კავშირის პრობლემა ან სერვერი მიუწვდომელია', 'error');
                showLoading(false);
                return null;
            }

            showLoading(false);

            if (res.status === 401 || res.status === 403) {
                logout();
                showToast('სესია დასრულდა. გთხოვთ თავიდან გაიაროთ ავტორიზაცია', 'error');
                return res;
            }

            if (!res.ok) {
                let errorMsg = res.statusText;
                try {
                    const errData = await res.clone().json();
                    errorMsg = errData.message || errorMsg;
                } catch {}
                console.error(`API ERROR ${res.status} ${path}: ${errorMsg}`);
                showToast(errorMsg || 'სერვერის შეცდომა', 'error');
            }

            return res;
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'success' ? 'linear-gradient(135deg,var(--accent-green),#1c8a16)' : 'linear-gradient(135deg,var(--accent-orange),#b34d00)';
            toast.style.display = 'block';
            toast.style.opacity = 1;
            setTimeout(() => {
                toast.style.transition = 'opacity 0.5s ease-out';
                toast.style.opacity = 0;
                setTimeout(() => {
                    toast.style.display = 'none';
                    toast.style.transition = 'none';
                }, 500);
            }, 4000);
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function closeModalOnBackdrop(e) {
            if (e.target.classList.contains('modal') || e.target.classList.contains('fullscreen-modal')) {
                e.target.classList.remove('active');
            }
        }

        function formatTime(time) {
            const diff = Date.now() - time;
            if (diff < 60000) return 'ახლახანს';
            if (diff < 3600000) return `${Math.floor(diff/60000)} წუთის წინ`;
            if (diff < 86400000) return `${Math.floor(diff/3600000)} საათის წინ`;
            if (diff < 604800000) return `${Math.floor(diff/86400000)} დღის წინ`;
            return new Date(time).toLocaleString('ka-GE');
        }

        function isNew(time) {
            return Date.now() - time < 3600000;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getBadgeColor(name) {
            name = name.toUpperCase();
            if (name === 'ADMIN') return 'var(--badge-admin)';
            if (name === 'VIP') return 'var(--badge-vip)';
            if (name === 'MODERATOR') return 'var(--badge-mod)';
            if (name === 'HELPER') return 'var(--badge-helper)';
            
            // Custom/Other Badges
            let hash = 0;
            for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash) % 360;
            return `linear-gradient(135deg, hsl(${hue},90%,60%), hsl(${hue + 30},70%,40%))`;
        }

        function renderBadge(name) {
            // Added data-name for specific styling and title for tooltip
            return `<span class="badge" data-name="${name.toUpperCase()}" style="background:${getBadgeColor(name)}" title="${name.toUpperCase()}">${name.toUpperCase()}</span>`;
        }

        function updateUI() {
            if (!userData) return;
            const avatarStyle = userData.profile.avatar ? `background-image:url(${userData.profile.avatar});background-size:cover;background-position:center;` : '';
            const avatarText = userData.profile.avatar ? '' : currentUser[0].toUpperCase();
            document.getElementById('navActions').innerHTML = `
                <div class="user-info" onclick="showProfile()">
                    <div class="user-avatar" style="${avatarStyle}">${avatarText}</div>
                    <span>${currentUser}</span>
                    <div class="user-badges">${userData.badges.map(renderBadge).join('')}</div>
                </div>
                <button class="btn btn-secondary" onclick="logout()"><i class="fas fa-sign-out-alt"></i> გასვლა</button>
            `;
        }

        async function updateSectionStats() {
            const res = await api('/post-counts');
            if (res && res.ok) {
                const counts = await res.json();
                document.querySelectorAll('.section').forEach(el => {
                    const count = counts[el.dataset.section] || 0;
                    el.querySelector('.sec-stats').textContent = count;
                });
            }
        }

        async function fetchPosts() {
            // Added skeleton loader logic here
            const list = document.getElementById('threadsList');
            if (list) {
                list.innerHTML = `
                    <div class="skeleton-loader" style="height:30px;width:70%;margin:1.5rem 0;"></div>
                    <div class="skeleton-loader" style="height:20px;width:90%;"></div>
                    <div class="skeleton-loader" style="height:20px;width:85%;"></div>
                `;
            }
            
            const res = await api(`/posts/${currentSection}`);
            if (res && res.ok) {
                sectionPosts = await res.json();
            } else {
                sectionPosts = [];
                console.warn(`პოსტების ჩატვირთვა ვერ მოხერხდა სექციისთვის: ${currentSection}`);
            }
            return sectionPosts;
        }

        async function renderThreads() {
            await fetchPosts();
            const list = document.getElementById('threadsList');
            list.innerHTML = '';
            const threads = sectionPosts.filter(p => !p.parentId)
                .sort((a, b) => b.pinned - a.pinned || b.time - a.time);

            if (threads.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:2rem">თრედები არ მოიძებნა</p>';
            }

            threads.forEach(thread => {
                const replies = sectionPosts.filter(p => p.parentId === thread.id).length;
                const lastActivity = formatTime(Math.max(thread.time, ...sectionPosts.filter(p => p.parentId === thread.id).map(p => p.time) || [thread.time]));
                const newInd = isNew(thread.time) ? '<span class="new-indicator" style="animation:pulse 1.5s infinite;">ახალი</span>' : '';
                const pinnedClass = thread.pinned ? ' pinned' : '';

                const div = document.createElement('div');
                div.className = `thread-card${pinnedClass}`;
                // Tilt effect on hover will be applied via CSS transform
                div.innerHTML = `
                    <h3>${escapeHtml(thread.title || thread.content.substring(0,60)+'...')}${newInd}</h3>
                    <div class="thread-info">
                        <span><i class="fas fa-user"></i> ${thread.author}</span>
                        <span><i class="fas fa-comments"></i> პასუხები: ${replies}</span>
                        <span><i class="fas fa-clock"></i> ${lastActivity}</span>
                    </div>
                    ${userData?.role === 'admin' ? `
                        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
                            <button class="btn btn-secondary" onclick="event.stopPropagation(); togglePin('${thread.id}')" style="font-size:0.85rem;padding:0.4rem 0.8rem">
                                <i class="fas fa-${thread.pinned ? 'times' : 'thumbtack'}"></i> ${thread.pinned ? 'განპინება' : 'დაფიქსირება'}
                            </button>
                            <button class="btn btn-secondary" style="background:var(--gradient-primary);color:var(--dark);font-size:0.85rem;padding:0.4rem 0.8rem" onclick="event.stopPropagation(); deleteThread('${thread.id}')">
                                <i class="fas fa-trash"></i> წაშლა
                            </button>
                        </div>
                    ` : ''}
                `;
                div.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) return;
                    openThread(thread.id, thread.title || thread.content.substring(0,60) + '...');
                };
                list.appendChild(div);
            });
        }

        async function renderThread() {
            await fetchPosts();
            const container = document.getElementById('threadPosts');
            container.innerHTML = '';
            const thread = sectionPosts.find(p => p.id === currentThread);
            if (!thread) {
                container.innerHTML = '<p style="text-align:center;color:var(--text-muted)">თრედი ვერ მოიძებნა</p>';
                return;
            }
            container.appendChild(createPostElement(thread, false));
            sectionPosts.filter(p => p.parentId === currentThread)
                .sort((a,b) => a.time - b.time)
                .forEach(p => container.appendChild(createPostElement(p, true)));
        }

        function createPostElement(post, isReply) {
            const avatarStyle = post.avatar ? `background-image:url(${post.avatar});background-size:cover;background-position:center;` : '';
            const avatarText = post.avatar ? '' : post.author[0].toUpperCase();
            const liked = post.likes?.includes(currentUser) ? 'liked' : '';
            const pinned = post.pinned && !isReply ? ' pinned' : '';
            const div = document.createElement('div');
            div.className = `post${pinned}`;
            div.style.animation = 'fadeInUp 0.6s ease-out'; // Fade in post
            div.innerHTML = `
                <div class="post-header">
                    <div class="user-avatar" style="${avatarStyle}">${avatarText}</div>
                    <span class="post-author" onclick="viewUserProfile('${post.author}')">${post.author}</span>
                    <div class="user-badges">${(post.badges || []).map(renderBadge).join('')}</div>
                    <span class="post-time">${formatTime(post.time)}</span>
                </div>
                ${!isReply ? `<h3>${escapeHtml(post.title || '')}</h3>` : ''}
                <div class="post-content">${escapeHtml(post.content).replace(/\n/g, '<br>')}</div>
                <div class="post-actions">
                    <button class="like-btn ${liked}" onclick="toggleLike('${post.id}')"><i class="fas fa-heart"></i> ${post.likes?.length || 0}</button>
                </div>
            `;
            return div;
        }

        function openThread(id, title) {
            currentThread = id;
            applyViewTransition('sectionView', 'threadView');
            document.getElementById('threadTitle').textContent = title;
            document.getElementById('newReplyForm').style.display = currentUser ? 'block' : 'none';
            updateBreadcrumbs('thread');
            renderThread();
            clearInterval(refreshInterval);
            refreshInterval = setInterval(renderThread, 30000);
        }

        function updateBreadcrumbs(type) {
            if (type === 'section') {
                const sectionEl = document.querySelector(`.section[data-section="${currentSection}"]`);
                const cat = sectionEl.closest('.cat').querySelector('.cat-header').textContent.trim();
                const sec = sectionEl.querySelector('.sec-title').textContent.trim();
                document.getElementById('sectionBreadcrumbs').innerHTML = `<span onclick="backToForumFromSection()" style="cursor:pointer;color:var(--text-muted); text-decoration:underline;">ფორუმი</span> <span style="color:var(--text-muted)">→</span> <span style="color:var(--text-muted)">${cat}</span> → <span style="color:var(--primary)">${sec}</span>`;
            } else if (type === 'thread') {
                const threadTitle = document.getElementById('threadTitle').textContent;
                document.getElementById('threadBreadcrumbs').innerHTML = document.getElementById('sectionBreadcrumbs').innerHTML + ` <span style="color:var(--text-muted)">→</span> <span style="color:var(--primary)">${threadTitle}</span>`;
            }
        }

        // --- AUTH & DATA HANDLING (Unchanged from original logic for preservation) ---

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            const res = await api('/login', {
                method: 'POST',
                body: JSON.stringify({username, password})
            });

            if (!res || !res.ok) {
                showToast('არასწორი მომხმარებელი ან პაროლი', 'error');
                return;
            }

            const data = await res.json();
            localData.token = data.token;
            currentUser = data.user.username;
            userData = data.user;
            localStorage.setItem(storageKey, JSON.stringify(localData));
            updateUI();
            closeModal('loginModal');
            showToast('შესვლა წარმატებით!');
            updateSectionStats();
        }

        async function handleRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;

            if (password.length < 8) {
                showToast('პაროლი უნდა იყოს მინიმუმ 8 სიმბოლო', 'error');
                return;
            }

            const code = String(Math.floor(10000000 + Math.random() * 90000000));

            try {
                await emailjs.send('service_uqvxc6o', 'Zaraticsregister9178', {
                    to_email: email,
                    to_name: username,
                    code: code
                });
                console.log('EmailJS წარმატებით გაიგზავნა');

                const res = await api('/register', {
                    method: 'POST',
                    body: JSON.stringify({username, email, password, code})
                });

                if (!res || !res.ok) {
                    showToast('რეგისტრაციის შეცდომა (შესაძლოა მომხმარებელი უკვე არსებობს)', 'error');
                    return;
                }

                sessionStorage.setItem('pendingEmail', email);
                closeModal('registerModal');
                document.getElementById('verifyModal').classList.add('active');
                showToast('კოდი გამოგზავნილია ელფოსტაზე');
            } catch (err) {
                console.error('EmailJS შეცდომა:', err);
                showToast('ელფოსტის გაგზავნა ვერ მოხერხდა', 'error');
            }
        }

        async function handleVerify(e) {
            e.preventDefault();
            const code = document.getElementById('verifyCode').value.trim();
            const email = sessionStorage.getItem('pendingEmail');

            const res = await api('/verify', {
                method: 'POST',
                body: JSON.stringify({email, code})
            });

            if (!res || !res.ok) {
                showToast('არასწორი კოდი', 'error');
                return;
            }

            const data = await res.json();
            localData.token = data.token;
            currentUser = data.user.username;
            userData = data.user;
            localStorage.setItem(storageKey, JSON.stringify(localData));
            updateUI();
            closeModal('verifyModal');
            sessionStorage.removeItem('pendingEmail');
            showToast('რეგისტრაცია წარმატებით დასრულდა!');
            updateSectionStats();
        }

        async function togglePin(postId) {
            if (userData?.role !== 'admin') return;
            const res = await api(`/posts/${currentSection}/${postId}/pin`, {method: 'POST'});
            if (res && res.ok) {
                currentThread ? renderThread() : renderThreads();
            }
        }

        async function deleteThread(threadId) {
            if (userData?.role !== 'admin') return;
            if (!confirm('ნამდვილად გსურთ თრედის წაშლა?')) return;

            const res = await api(`/posts/${currentSection}/delete`, {
                method: 'POST',
                body: JSON.stringify({threadId})
            });

            if (res && res.ok) {
                await fetchPosts();
                renderThreads();
                updateSectionStats();
                showToast('თრედი წაშლილია');
            }
        }

        async function toggleLike(postId) {
            const res = await api(`/posts/${currentSection}/${postId}/like`, {method: 'POST'});
            if (res && res.ok) {
                currentThread ? renderThread() : renderThreads();
            }
        }

        async function handleNewThread(e) {
            e.preventDefault();
            const title = document.getElementById('threadTitleInput').value.trim();
            const content = document.getElementById('threadContent').value.trim();

            const res = await api(`/posts/${currentSection}`, {
                method: 'POST',
                body: JSON.stringify({title, content})
            });

            if (res && res.ok) {
                document.getElementById('threadTitleInput').value = '';
                document.getElementById('threadContent').value = '';
                closeModal('newThreadModal');
                renderThreads();
                updateSectionStats();
                showToast('თრედი შეიქმნა');
            } else {
                showToast('თრედის შექმნა ვერ მოხერხდა', 'error');
            }
        }

        async function handleNewReply(e) {
            e.preventDefault();
            const content = document.getElementById('replyContent').value.trim();

            const res = await api(`/posts/${currentSection}`, {
                method: 'POST',
                body: JSON.stringify({content, parentId: currentThread})
            });

            if (res && res.ok) {
                document.getElementById('replyContent').value = '';
                renderThread();
                updateSectionStats();
                showToast('პასუხი გაგზავნილია');
            }
        }

        function previewAvatar(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => document.getElementById('avatarPreview').style.backgroundImage = `url(${e.target.result})`;
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function showProfile() {
            const res = await api('/me');
            if (!res || !res.ok) {
                logout();
                return;
            }

            const data = await res.json();
            userData = data;
            currentUser = data.username;

            applyViewTransition('forumView', 'profileView');
            applyViewTransition('sectionView', 'profileView');
            applyViewTransition('threadView', 'profileView');

            const avatarStyle = data.profile.avatar ? `background-image:url(${data.profile.avatar});background-size:cover;background-position:center;` : 'background:var(--primary-dark);';
            document.getElementById('profileAvatarLarge').style.cssText = avatarStyle;
            document.getElementById('profileAvatarLarge').textContent = data.profile.avatar ? '' : currentUser[0].toUpperCase();
            document.getElementById('profileUsername').textContent = currentUser;
            document.getElementById('profileBadges').innerHTML = (data.badges || []).map(renderBadge).join('');

            document.getElementById('displayName').textContent = data.profile.name || '-';
            document.getElementById('displayEmail').textContent = data.profile.email || '-';
            document.getElementById('displayPhone').textContent = data.profile.phone || '-';
            document.getElementById('displayBio').textContent = data.profile.bio || '-';

            document.getElementById('editName').value = data.profile.name || '';
            document.getElementById('editEmail').value = data.profile.email || '';
            document.getElementById('editPhone').value = data.profile.phone || '';
            document.getElementById('editBio').value = data.profile.bio || '';

            document.getElementById('adminTab').style.display = data.role === 'admin' ? 'block' : 'none';

            // Reset tabs to info
            switchTab(null, 'info');
        }

        async function handleProfileUpdate(e) {
            e.preventDefault();
            
            // Success animation on save button (Micro-interaction)
            const saveBtn = document.getElementById('saveProfileBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-sync fa-spin"></i> იტვირთება...';
            saveBtn.disabled = true;

            const formData = new FormData();
            const avatarFile = document.getElementById('editAvatar').files[0];
            if (avatarFile) {
                 // Simulate file upload (replace with actual upload logic if applicable)
                if (avatarFile.size > 2 * 1024 * 1024) {
                    showToast('ფაილი ძალიან დიდია (მაქს. 2MB)', 'error');
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                formData.append('avatar', avatarFile);
            }
            formData.append('name', document.getElementById('editName').value.trim());
            formData.append('email', document.getElementById('editEmail').value.trim());
            formData.append('phone', document.getElementById('editPhone').value.trim());
            formData.append('bio', document.getElementById('editBio').value.trim());

            try {
                const res = await fetch(API_URL + '/me', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localData.token}` },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    userData = data;
                    updateUI();
                    showProfile();
                    showToast('პროფილი განახლდა', 'success');
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> შენახულია';
                    setTimeout(() => { saveBtn.innerHTML = originalText; saveBtn.disabled = false; }, 2000);
                } else {
                    showToast('პროფილის განახლება ვერ მოხერხდა', 'error');
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            } catch (error) {
                showToast('ქსელის შეცდომა განახლებისას', 'error');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        async function assignBadge() {
            if (userData?.role !== 'admin') return showToast('წვდომა არ გაქვთ', 'error');
            const username = document.getElementById('badgeUsername').value.trim();
            const badge = document.getElementById('badgeName').value.trim();
            if (!username || !badge) return showToast('შეავსეთ ყველა ველი', 'error');

            const res = await api(`/admin/badge/${username}`, {
                method: 'POST',
                body: JSON.stringify({badge})
            });

            if (res && res.ok) showToast('ბეჯი მინიჭებულია');
        }

        async function removeBadge() {
            if (userData?.role !== 'admin') return showToast('წვდომა არ გაქვთ', 'error');
            const username = document.getElementById('removeBadgeUsername').value.trim();
            const badge = document.getElementById('removeBadgeName').value.trim();
            if (!username || !badge) return showToast('შეავსეთ ყველა ველი', 'error');

            const res = await api(`/admin/badge/${username}`, {
                method: 'DELETE',
                body: JSON.stringify({badge})
            });

            if (res && res.ok) showToast('ბეჯი წაშლილია');
        }

        function logout() {
            localStorage.removeItem(storageKey);
            localData = {token: null};
            currentUser = null;
            userData = null;
            document.getElementById('navActions').innerHTML = `<button class="btn btn-primary" onclick="showWelcomeModal()">შესვლა</button><button class="btn btn-secondary" onclick="showWelcomeModal()">რეგისტრაცია</button>`;
            backToForum(false); // No animation on logout
            showToast('გამოსვლა წარმატებული');
            showWelcomeModal();
        }

        function backToForum(animate = true) {
            applyViewTransition('profileView', 'forumView', animate);
            applyViewTransition('sectionView', 'forumView', animate);
            applyViewTransition('threadView', 'forumView', animate);
            currentSection = null;
            currentThread = null;
            clearInterval(refreshInterval);
        }

        function backToForumFromSection() {
            applyViewTransition('sectionView', 'forumView');
            currentSection = null;
            clearInterval(refreshInterval);
        }

        function backToSectionFromThread() {
            applyViewTransition('threadView', 'sectionView');
            currentThread = null;
            renderThreads();
            clearInterval(refreshInterval);
            refreshInterval = setInterval(renderThreads, 30000);
        }

        function switchTab(e, tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (e) e.currentTarget.classList.add('active');
            else document.querySelector(`.tab[onclick*="'${tab}'"]`).classList.add('active');
            
            const content = document.getElementById(tab === 'admin' ? 'adminTabContent' : tab + 'Tab');
            if (content) content.classList.add('active');
        }

        function showLogin() { closeModal('welcomeModal'); document.getElementById('loginModal').classList.add('active'); }
        function showRegister() { closeModal('welcomeModal'); document.getElementById('registerModal').classList.add('active'); }

        function showNewThreadModal() {
            const section = document.querySelector(`.section[data-section="${currentSection}"]`);
            const isViewOnly = section?.dataset.viewOnly === 'true';
            if (isViewOnly && (!userData || userData.role !== 'admin')) {
                showToast('ამ სექციაში მხოლოდ ადმინისტრაცია ქმნის თრედებს', 'error');
                return;
            }
            if (!currentUser) {
                showToast('გთხოვთ გაიაროთ ავტორიზაცია', 'error');
                showLogin();
                return;
            }
            document.getElementById('newThreadModal').classList.add('active');
        }

        let currentSlide = 0;
        function showSlide(n) {
            document.querySelectorAll('.carousel-slide').forEach((s,i) => s.classList.toggle('active', i===n));
            document.querySelectorAll('.carousel-dot').forEach((d,i) => d.classList.toggle('active', i===n));
            currentSlide = n;
        }
        function nextSlide() { showSlide((currentSlide + 1) % 2); }
        function prevSlide() { showSlide((currentSlide - 1 + 2) % 2); }
        function showWelcomeModal() { 
            if (currentUser) return; // Don't show if logged in
            document.getElementById('welcomeModal').classList.add('active'); 
            showSlide(0); 
        }

        async function viewUserProfile(username) {
            const res = await api(`/users/${username}`);
            if (!res || !res.ok) {
                showToast('მომხმარებელი ვერ მოიძებნა', 'error');
                return;
            }

            const data = await res.json();
            
            applyViewTransition('forumView', 'profileView');
            applyViewTransition('sectionView', 'profileView');
            applyViewTransition('threadView', 'profileView');

            document.getElementById('profileUsername').textContent = username;
            document.getElementById('profileBadges').innerHTML = (data.badges || []).map(renderBadge).join('');
            document.getElementById('displayName').textContent = data.profile.name || '-';
            document.getElementById('displayEmail').textContent = data.profile.email || '-';
            document.getElementById('displayPhone').textContent = data.profile.phone || '-';
            document.getElementById('displayBio').textContent = data.profile.bio || '-';

            const avatarStyle = data.profile.avatar ? `background-image:url(${data.profile.avatar});background-size:cover;background-position:center;` : 'background:var(--primary-dark);';
            document.getElementById('profileAvatarLarge').style.cssText = avatarStyle;
            document.getElementById('profileAvatarLarge').textContent = data.profile.avatar ? '' : username[0].toUpperCase();

            const isOwn = username === currentUser;
            // Hide edit and admin tabs for non-owner/non-admin view
            document.querySelector('.tab[onclick*="edit"]').style.display = isOwn ? 'block' : 'none';
            document.getElementById('adminTab').style.display = 'none';

            // Reset tabs to info view
            switchTab(null, 'info');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('loading').style.display = 'block'; // Initial loading state
            await updateSectionStats();
            document.getElementById('loading').style.display = 'none';

            if (localData.token) {
                const res = await api('/me');
                if (res && res.ok) {
                    const data = await res.json();
                    currentUser = data.username;
                    userData = data;
                    updateUI();
                    updateSectionStats();
                } else {
                    localStorage.removeItem(storageKey);
                    localData.token = null;
                    showWelcomeModal();
                }
            } else {
                showWelcomeModal();
            }

            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
            document.getElementById('verifyForm').addEventListener('submit', handleVerify);
            document.getElementById('newThreadForm').addEventListener('submit', handleNewThread);
            document.getElementById('newReplyForm').addEventListener('submit', handleNewReply);
            document.getElementById('profileEditForm').addEventListener('submit', handleProfileUpdate);

            document.querySelectorAll('.section').forEach(el => {
                el.addEventListener('click', async () => {
                    currentSection = el.dataset.section;
                    applyViewTransition('forumView', 'sectionView');
                    document.getElementById('sectionTitle').textContent = el.querySelector('.sec-title').textContent;
                    updateBreadcrumbs('section');
                    await renderThreads();

                    const newThreadBtn = document.querySelector('#sectionView .btn-primary');
                    const isViewOnly = el.dataset.viewOnly === 'true';
                    newThreadBtn.style.display = (isViewOnly && (!userData || userData.role !== 'admin')) ? 'none' : 'block';

                    clearInterval(refreshInterval);
                    refreshInterval = setInterval(renderThreads, 30000);
                });
            });

            // --- SCROLL ANIMATION FOR NAVBAR BLUR (Micro-interaction) ---
            window.addEventListener('scroll', () => {
                const navbar = document.getElementById('mainNavbar');
                if (window.scrollY > 50) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }
            });
        });
    </script>
</body>
</html>
